<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¨«è¨˜éŒ„å°ˆç”¨ç¶²ç«™</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        mono: ['"Orbitron"', 'monospace']
                    },
                    colors: {
                        neon: { blue: '#00f3ff', purple: '#bc13fe', pink: '#ff0055', green: '#0aff00', yellow: '#facc15' },
                        glass: { 100: 'rgba(255, 255, 255, 0.05)', 200: 'rgba(255, 255, 255, 0.1)' },
                        dark: { bg: '#050511' }
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'accordion-down': 'accordionDown 0.3s ease-out forwards',
                    },
                    keyframes: {
                        popIn: { from: { opacity: 0, transform: 'scale(0.9) translateY(20px)' }, to: { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        accordionDown: { from: { opacity: 0, transform: 'translateY(-10px)' }, to: { opacity: 1, transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #050511; color: #ffffff;
            font-family: "Noto Sans TC", sans-serif;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #050511; overflow: hidden; }
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; animation: blob 15s infinite alternate; }
        @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 100% { transform: translate(20px, 20px) scale(1.1); } }
        
        .glass-panel { background: rgba(18, 18, 28, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .glass-input { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.15); color: white; transition: all 0.2s; }
        .glass-input:focus { border-color: #00f3ff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); background: rgba(0, 0, 0, 0.7); outline: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #toast-container { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 380px; pointer-events: none; }
        .toast-msg { background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(12px); color: white; padding: 14px 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.6); pointer-events: auto; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; animation: pop-in 0.3s; }
        .toast-success i { color: #0aff00; } .toast-error i { color: #ff0055; } .toast-info i { color: #00f3ff; }
        
        .nav-item.active { color: #00f3ff; text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); transform: translateY(-2px); }
        
        /* Keypad Styles */
        .keypad-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 1.5rem; font-weight: 700; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .keypad-btn:active { background: rgba(0,243,255,0.2); border-color: #00f3ff; transform: scale(0.95); }
        
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ div { animation: accordion-down 0.3s ease-out; }
    </style>
</head>
<body class="text-white pb-24 font-sans">

    <div class="bg-animation">
        <div class="bg-blob bg-neon-purple w-96 h-96 top-0 left-0"></div>
        <div class="bg-blob bg-neon-blue w-[30rem] h-[30rem] bottom-0 right-0"></div>
    </div>

    <!-- UI Elements -->
    <div id="toast-container"></div>
    
    <!-- Confirm Dialog -->
    <div id="custom-confirm" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-6 opacity-0 transition-opacity duration-200">
        <div class="glass-panel w-full max-w-xs rounded-3xl p-6 transform scale-90 transition-transform duration-200" id="confirm-box">
            <h3 class="text-lg font-bold text-center mb-2 text-white">ç¢ºèªæ“ä½œ</h3>
            <p class="text-gray-400 text-center text-sm mb-6" id="confirm-msg">...</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3 rounded-xl bg-white/10 text-gray-300 font-medium">å–æ¶ˆ</button>
                <button id="confirm-yes-btn" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-neon-pink to-red-600 text-white font-bold shadow-lg">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Auth -->
    <div id="auth-screen" class="fixed inset-0 z-50 overflow-y-auto bg-[#050511]">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 py-12">
            <div class="glass-panel w-full max-w-[380px] p-8 rounded-[2.5rem] border-t border-white/20 relative mx-auto shadow-2xl animate-pop-in">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-black tracking-wide text-white">é¨«è¨˜éŒ„å°ˆç”¨ç¶²ç«™</h1>
                    <p class="text-neon-blue text-xs tracking-widest mt-1 opacity-80 font-mono">V4.8 DEBUGGED</p>
                </div>
                <div id="login-form" class="space-y-4">
                    <input type="email" id="email" placeholder="é›»å­éƒµä»¶" class="glass-input w-full p-4 rounded-xl text-base placeholder-gray-500">
                    <input type="password" id="password" placeholder="å¯†ç¢¼" class="glass-input w-full p-4 rounded-xl text-base placeholder-gray-500">
                    <button onclick="handleLogin()" id="login-btn" class="w-full py-4 bg-gradient-to-r from-neon-blue to-neon-purple rounded-xl font-bold text-white text-lg shadow-lg active:scale-95 transition-transform">é€²å…¥ç³»çµ±</button>
                </div>
                <div class="mt-6 text-center text-sm text-gray-400">
                    <span onclick="toggleMode()" class="cursor-pointer hover:text-white transition-colors">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <span class="text-neon-blue font-bold border-b border-neon-blue/30 pb-0.5">è¨»å†Š</span></span>
                </div>
                <div class="mt-8 space-y-3">
                     <button onclick="handleGoogleLogin()" class="w-full py-3 bg-white text-gray-900 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">Google ç™»å…¥</button>
                    <button onclick="handleGuest()" class="w-full py-3 border border-white/20 text-gray-300 rounded-xl font-medium active:scale-95 transition-transform hover:bg-white/5 group"><i class="fa-solid fa-user-secret mr-2 group-hover:text-neon-green transition-colors"></i>è¨ªå®¢æ¨¡å¼</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500">
        
        <div id="guest-banner" class="hidden bg-gradient-to-r from-neon-green/20 to-transparent border-b border-neon-green/30 text-neon-green px-4 py-2 text-xs font-bold text-center"><i class="fa-solid fa-eye mr-2"></i> è¨ªå®¢æ¨¡å¼ï¼šè³‡æ–™ä¸ä¿å­˜</div>

        <header class="pt-6 px-6 pb-2">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full p-[2px] bg-gradient-to-r from-neon-blue to-neon-pink shadow-[0_0_15px_rgba(188,19,254,0.4)]"><img id="user-avatar" src="" class="w-full h-full rounded-full bg-gray-900 object-cover"></div>
                    <div><p class="text-[10px] text-neon-blue font-bold tracking-wider uppercase mb-0.5">V4.8 Pro</p><h2 class="text-xl font-bold text-white leading-none tracking-tight" id="user-name">User</h2></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettings()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <!-- Dashboard Card (Visible only on non-attendance pages) -->
            <div id="dashboard-card" class="glass-panel rounded-[2rem] p-6 relative overflow-hidden group border border-white/10 transition-all">
                <div class="absolute -right-12 -top-12 w-48 h-48 bg-neon-blue/10 blur-3xl rounded-full"></div>
                <div class="flex justify-between items-start mb-2"><div><p class="text-gray-400 text-xs font-medium mb-1 flex items-center gap-1"><i class="fa-solid fa-coins text-neon-blue"></i> æœ¬æœˆæ·¨åˆ©æ½¤</p><h1 class="text-4xl font-black text-white tracking-tight font-mono" id="net-profit">$0</h1></div><div class="text-right"><span class="text-xs font-bold px-2 py-1 rounded bg-white/10 text-white border border-white/5 font-mono" id="profit-margin">0%</span></div></div>
                <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden mt-4"><div id="profit-bar" class="h-full bg-gradient-to-r from-neon-blue to-neon-purple w-0 transition-all duration-1000"></div></div>
            </div>
        </header>

        <main class="px-4 pb-28 relative z-10 max-w-2xl mx-auto mt-4">
            <!-- This container switches content based on view -->
            <div id="content-area"></div>
        </main>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 w-full glass-panel h-20 z-30 rounded-t-[2rem] border-t border-white/10 shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
            <div class="flex justify-around items-center h-full max-w-2xl mx-auto px-2 pb-2">
                <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-dashboard"><i class="fa-solid fa-chart-line text-lg mb-1"></i><span class="text-[10px] font-bold">æ¦‚è¦½</span></button>
                <button onclick="switchView('camel')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-camel"><i class="fa-solid fa-building text-lg mb-1"></i><span class="text-[10px] font-bold">é§±é§æ¼†</span></button>
                <button onclick="switchView('reels')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-reels"><i class="fa-brands fa-instagram text-lg mb-1"></i><span class="text-[10px] font-bold">Reels</span></button>
                <button onclick="switchView('kwuntong')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-kwuntong"><i class="fa-solid fa-shop text-lg mb-1"></i><span class="text-[10px] font-bold">è§€å¡˜</span></button>
                <button onclick="switchView('attendance')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-attendance"><i class="fa-solid fa-clock text-lg mb-1"></i><span class="text-[10px] font-bold">æ‰“å¡</span></button>
                <button onclick="switchView('expense')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-expense"><i class="fa-solid fa-file-invoice-dollar text-lg mb-1"></i><span class="text-[10px] font-bold">å…¥è²¨</span></button>
            </div>
        </div>

        <!-- Entry Modal -->
        <div id="entry-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity duration-300" onclick="closeEntry()"></div>
            <div class="relative w-full max-w-lg glass-panel rounded-[2rem] p-6 sm:p-8 transform scale-95 opacity-0 transition-all duration-300 shadow-2xl border border-white/10 flex flex-col max-h-[85vh]" id="modal-content">
                <div class="flex-1 overflow-y-auto no-scrollbar">
                    <h3 class="text-2xl font-black text-white mb-6 flex items-center justify-center gap-2 text-center" id="modal-title">æ–°å¢è¨˜éŒ„</h3>
                    <div id="modal-form-container" class="space-y-5"></div>
                </div>
                <div class="mt-6 flex flex-col gap-3 justify-center pt-4 border-t border-white/10">
                    <button id="modal-submit-btn" onclick="submitEntry()" class="w-full py-4 bg-white text-black rounded-xl font-bold shadow-lg hover:bg-gray-200 transition-all active:scale-95 text-lg">ç¢ºèªå„²å­˜</button>
                    <button id="modal-delete-btn" onclick="deleteFromModal()" class="w-full py-4 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl font-bold hidden hover:bg-red-500/20 transition-all active:scale-95 text-lg">åˆªé™¤æ­¤è¨˜éŒ„</button>
                </div>
                <button onclick="closeEntry()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>

        <!-- Keypad -->
        <div id="custom-keypad" class="fixed bottom-0 left-0 w-full glass-panel z-[60] transform translate-y-full transition-transform duration-200 border-t border-white/20 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
            <div class="flex justify-between items-center px-6 py-2 bg-black/40 border-b border-white/5 backdrop-blur-xl">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest font-mono">HINES TACTILE INPUT</span>
                <button onclick="closeKeypad()" class="text-neon-blue font-bold px-4 py-1 rounded-full bg-neon-blue/10 hover:bg-neon-blue hover:text-black transition-colors text-sm"><i class="fa-solid fa-check"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3 p-4 bg-[#0a0a12]">
                <button onclick="kpInput(1)" class="keypad-btn h-14">1</button><button onclick="kpInput(2)" class="keypad-btn h-14">2</button><button onclick="kpInput(3)" class="keypad-btn h-14">3</button>
                <button onclick="kpInput(4)" class="keypad-btn h-14">4</button><button onclick="kpInput(5)" class="keypad-btn h-14">5</button><button onclick="kpInput(6)" class="keypad-btn h-14">6</button>
                <button onclick="kpInput(7)" class="keypad-btn h-14">7</button><button onclick="kpInput(8)" class="keypad-btn h-14">8</button><button onclick="kpInput(9)" class="keypad-btn h-14">9</button>
                <button onclick="kpInput('.')" class="keypad-btn h-14">.</button><button onclick="kpInput(0)" class="keypad-btn h-14">0</button><button onclick="kpDel()" class="keypad-btn h-14 keypad-del"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC2mm7_vjrJMUekBShe3BH6VdoPRt-yZqI", authDomain: "hinesrc-25cee.firebaseapp.com", projectId: "hinesrc-25cee", storageBucket: "hinesrc-25cee.firebasestorage.app", messagingSenderId: "873846921584", appId: "1:873846921584:web:079586988dee370cc957b5", measurementId: "G-TQRKF54G4F" };
        
        let app, auth, db;
        // ğŸš¨ IMPORTANT: Strict path requires appId
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hinesrc-25cee'; 
        let currentUser = null, records = [], isGuest = false, currentFilter = 'dashboard';
        let chartInstance = null, unsubscribe = null, isLoginView = true;
        let activeKeypadInput = null, workStartTime = null, activeEditId = null;
        let customSources = ['æ·˜å¯¶', 'æ‹¼å¤šå¤š', 'Carousell', 'Amazon', 'HKTVMall'];
        let activeType = ''; 

        function init() {
            try {
                app = firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore();
                auth.onAuthStateChanged(user => {
                    if (user && !isGuest) { currentUser = user; showApp(); loadFirebaseData(); loadSettings(); checkAttendanceStatus(); } 
                    else if (!isGuest) { showAuth(); }
                });
                startClock();
            } catch (e) { showToast("ç³»çµ±éŒ¯èª¤: " + e.message, "error"); }
        }

        // --- Data Logic (Strict Path Fix) ---
        function getUserRef() {
            // Path: artifacts/{appId}/users/{userId}
            return db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid);
        }

        function loadFirebaseData() {
            if(unsubscribe) unsubscribe();
            const ref = getUserRef().collection('records');
            unsubscribe = ref.onSnapshot(snap => {
                records = snap.docs.map(d => ({id: d.id, ...d.data()}));
                records.sort((a,b) => {
                    const da = new Date(a.date).getTime() || 0;
                    const db = new Date(b.date).getTime() || 0;
                    return db - da; // Descending
                });
                // Force Refresh UI based on current view
                if(currentFilter === 'attendance') renderAttendance(document.getElementById('content-area'));
                else if(currentFilter === 'settings') renderSettings(document.getElementById('content-area'));
                else if(currentFilter === 'dashboard') renderDashboard(document.getElementById('content-area'), calculateStats());
                else renderListView(document.getElementById('content-area'), currentFilter);
            }, error => {
                console.error("Data Load Error:", error);
                showToast("ç„¡æ³•è®€å–è³‡æ–™: " + error.code, "error");
            });
        }

        function loadSettings() {
            if(isGuest) return;
            getUserRef().get().then(doc => { if(doc.exists && doc.data().customSources) customSources = doc.data().customSources; });
        }

        // --- Save Logic ---
        async function submitEntry() {
            const btn = document.getElementById('modal-submit-btn');
            const dateVal = document.getElementById('in-date').value;
            if (!dateVal) { showToast("è«‹é¸æ“‡æ—¥æœŸ", "error"); return; }

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            btn.disabled = true;

            let data = { type: activeType, date: dateVal }; // dateVal is YYYY-MM-DD
            if(!activeEditId && !isGuest) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();

            try {
                if(activeType==='camel') { data.upper = document.getElementById('in-upper').value; data.lower = document.getElementById('in-lower').value; data.note = document.getElementById('in-note').value; }
                else if(activeType==='reels') { data.income = document.getElementById('in-income').value; data.content = document.getElementById('in-content').value; }
                else if(activeType==='kwuntong') { 
                    data.lower = document.getElementById('in-lower').value; 
                    data.refund = document.getElementById('in-refund').value;
                    if(!activeEditId) data.refunded = false; 
                }
                else if(activeType==='expense') { data.amount = document.getElementById('in-amount').value; data.name = document.getElementById('in-name').value; data.source = document.getElementById('in-source').value; }

                if(isGuest) {
                    if(activeEditId) { const idx=records.findIndex(r=>r.id===activeEditId); if(idx!==-1) records[idx]={...records[idx],...data}; }
                    else { data.id='g_'+Date.now(); records.unshift(data); }
                    showToast("å·²å„²å­˜ (è¨ªå®¢)", "success");
                } else {
                    const ref = getUserRef().collection('records');
                    if(activeEditId) await ref.doc(activeEditId).update(data); else await ref.add(data);
                    showToast("å·²åŒæ­¥é›²ç«¯", "success");
                }
                closeEntry(); 
                // Wait slightly for snapshot to fire, or manually re-render
                setTimeout(() => { if(!isGuest) switchView(currentFilter); }, 300);
            } catch(e) {
                console.error(e);
                showToast("å„²å­˜å¤±æ•—: " + e.message, "error");
            } finally {
                btn.innerHTML = 'ç¢ºèªå„²å­˜';
                btn.disabled = false;
            }
        }

        // --- Attendance (Fixed Logic) ---
        function checkAttendanceStatus() {
            if(isGuest) return;
            // Use correct path
            getUserRef().collection('attendance').doc('current').onSnapshot(doc => {
                const statusText = document.getElementById('work-status-text');
                const btnIn = document.getElementById('btn-clock-in');
                const btnOut = document.getElementById('btn-clock-out');
                const activeInfo = document.getElementById('active-work-info');
                
                // If view is not active, these might be null
                if (!btnIn) return; 

                if (doc.exists) {
                    workStartTime = doc.data().startTime.toDate();
                    statusText.innerText = `ä¸Šç­ä¸­ (${workStartTime.getHours()}:${String(workStartTime.getMinutes()).padStart(2,'0')} é–‹å§‹)`;
                    statusText.className = "text-neon-green text-xs mt-4 font-bold animate-pulse text-left";
                    btnIn.classList.add('hidden'); btnOut.classList.remove('hidden'); activeInfo.classList.remove('hidden');
                } else {
                    workStartTime = null;
                    statusText.innerText = "æº–å‚™å°±ç·’"; statusText.className = "text-gray-500 text-xs mt-4 font-bold text-left";
                    btnIn.classList.remove('hidden'); btnOut.classList.add('hidden'); activeInfo.classList.add('hidden');
                }
            });
        }
        
        async function startWork() { 
            if(isGuest) { showToast("è¨ªå®¢æ¨¡å¼ç„¡æ³•æ‰“å¡", "info"); return; } 
            try { 
                await getUserRef().collection('attendance').doc('current').set({ startTime: firebase.firestore.FieldValue.serverTimestamp() }); 
                showToast("æ‰“å¡æˆåŠŸ", "success"); 
            } catch(e) { showToast("å¤±æ•—: " + e.code, "error"); } 
        }

        async function endWork() {
            if(isGuest) return;
            try {
                const docRef = getUserRef().collection('attendance').doc('current');
                const doc = await docRef.get();
                if(!doc.exists) return;
                const start = doc.data().startTime.toDate(), end = new Date();
                const diffMs = end - start, diffMins = diffMs / 1000 / 60;
                const blocks = Math.ceil(diffMins / 30);
                const pay = blocks * 25, hours = (blocks * 0.5).toFixed(1);
                
                // Save formatted time
                const sStr = start.toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'});
                const eStr = end.toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'});
                
                const recordData = { 
                    type: 'attendance', 
                    date: `${end.getFullYear()}-${String(end.getMonth()+1).padStart(2,'0')}-${String(end.getDate()).padStart(2,'0')}`, 
                    amount: pay, 
                    note: `å·¥æ™‚: ${hours}å°æ™‚`, 
                    clockIn: sStr, 
                    clockOut: eStr, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                };
                
                await getUserRef().collection('records').add(recordData);
                await docRef.delete(); workStartTime = null; showToast(`è–ªè³‡ $${pay} å·²è¨˜éŒ„`, "success");
            } catch(e) { showToast("çµç®—å¤±æ•—", "error"); }
        }

        // --- Render Views ---
        function switchView(view) {
            currentFilter = view;
            // Nav Highlighting
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-neon-blue', 'active'); el.classList.add('text-gray-500'); });
            const activeNav = document.getElementById(`nav-${view}`);
            if(activeNav) { activeNav.classList.remove('text-gray-500'); activeNav.classList.add('text-neon-blue', 'active'); }

            const area = document.getElementById('content-area');
            const stats = calculateStats();
            document.getElementById('net-profit').innerText = `$${stats.net}`;
            let margin = stats.inc > 0 ? Math.round(((stats.inc - stats.exp)/stats.inc)*100) : 0;
            document.getElementById('profit-margin').innerText = `${margin}%`;
            document.getElementById('profit-bar').style.width = `${Math.max(0, margin)}%`;
            
            // Dashboard Visibility
            const dashCard = document.getElementById('dashboard-card');
            if(view === 'attendance') dashCard.classList.add('hidden'); else dashCard.classList.remove('hidden');

            if (view === 'dashboard') renderDashboard(area, stats);
            else if (view === 'settings') renderSettings(area);
            else if (view === 'attendance') renderAttendance(area);
            else renderListView(area, view);
        }

        function renderAttendance(container) {
            container.innerHTML = `
                <div class="glass-panel p-6 rounded-3xl w-full max-w-sm mx-auto border border-white/10 relative overflow-hidden text-center animate-slide-up">
                    <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-business-time text-6xl text-white"></i></div>
                    <p class="text-gray-400 text-sm mb-1 font-mono text-left" id="clock-date">--/--</p>
                    <h1 class="text-5xl font-black text-white font-mono tracking-wider text-left mb-4" id="clock-time">00:00</h1>
                    <div id="active-work-info" class="hidden text-left space-y-3 border-t border-white/10 pt-4 mt-2">
                        <div><p class="text-xs text-gray-500">å·²ä¸Šç­æ™‚é–“</p><p class="text-2xl text-neon-green font-bold font-mono" id="work-duration">00:00:00</p></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-[10px] text-gray-500">1å°æ™‚å¾Œä¸‹ç­</p><p class="text-sm text-white font-mono" id="est-1h">--:--</p></div>
                            <div><p class="text-[10px] text-gray-500">2å°æ™‚å¾Œä¸‹ç­</p><p class="text-sm text-white font-mono" id="est-2h">--:--</p></div>
                        </div>
                    </div>
                    <p class="text-gray-500 text-xs mt-4 font-bold text-left" id="work-status-text">è®€å–ä¸­...</p>
                </div>
                <div class="grid grid-cols-1 gap-4 max-w-xs mx-auto mt-6 animate-slide-up" style="animation-delay: 0.1s">
                    <button onclick="startWork()" id="btn-clock-in" class="py-4 bg-gradient-to-r from-neon-green to-emerald-600 rounded-2xl font-black text-white text-lg shadow-lg active:scale-95 transition-transform"><i class="fa-solid fa-play mr-2"></i> ä¸Šç­æ‰“å¡</button>
                    <button onclick="endWork()" id="btn-clock-out" class="hidden py-4 bg-gradient-to-r from-neon-pink to-red-600 rounded-2xl font-black text-white text-lg shadow-lg active:scale-95 transition-transform"><i class="fa-solid fa-stop mr-2"></i> ä¸‹ç­çµç®—</button>
                </div>
                <div class="mt-8 animate-slide-up" style="animation-delay: 0.2s">
                    <h3 class="text-sm font-bold text-gray-300 mb-3 px-2">æ­·å²æ‰“å¡</h3>
                    <div id="attendance-list" class="space-y-2 pb-20"></div>
                </div>
            `;
            // Trigger check manually since we just created the DOM elements
            checkAttendanceStatus();
            
            const attRecords = records.filter(r => r.type === 'attendance').slice(0, 10);
            document.getElementById('attendance-list').innerHTML = attRecords.length ? attRecords.map(renderCard).join('') : `<div class="text-center text-xs text-gray-500">ç„¡è¨˜éŒ„</div>`;
        }

        // ... [Include all other render, modal, keypad, and calc functions from V4.6, ensuring they use getUserRef()] ...
        // For brevity, inserting essential parts. The key fix is getUserRef().

        function calculateStats() {
            let inc = 0, exp = 0, sources = { camel: 0, reels: 0, kwuntong: 0, attendance: 0 };
            records.forEach(r => {
                if(r.type === 'expense') exp += Number(r.amount || 0);
                else {
                    let val = 0;
                    if(r.type === 'camel') val = Number(r.upper || 0) + Number(r.lower || 0);
                    if(r.type === 'reels') val = Number(r.income || 0);
                    if(r.type === 'kwuntong') {
                        val = Number(r.lower || 0); 
                        exp += Number(r.refund || 0);
                        if (r.refunded) val += Number(r.refund || 0);
                    }
                    if(r.type === 'attendance') val = Number(r.amount || 0);
                    inc += val;
                    if(sources[r.type] !== undefined) sources[r.type] += val;
                }
            });
            return { inc, exp, net: inc - exp, sources };
        }

        function renderDashboard(container, stats) {
            container.innerHTML = `<div class="grid grid-cols-2 gap-3 mb-6 animate-slide-up"><div onclick="switchView('income')" class="glass-panel p-4 rounded-2xl cursor-pointer hover:border-neon-green/50 transition-all active:scale-95"><div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-neon-green shadow-[0_0_8px_#0aff00]"></div><p class="text-xs text-gray-400 font-bold">ç¸½æ”¶å…¥</p></div><p class="text-lg font-bold text-white tracking-wide font-mono">$${stats.inc}</p></div><div onclick="switchView('expense')" class="glass-panel p-4 rounded-2xl cursor-pointer hover:border-neon-pink/50 transition-all active:scale-95"><div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-neon-pink shadow-[0_0_8px_#ff0055]"></div><p class="text-xs text-gray-400 font-bold">ç¸½å…¥è²¨</p></div><p class="text-lg font-bold text-white tracking-wide font-mono">$${stats.exp}</p></div></div><div class="glass-panel p-4 rounded-3xl mb-6 h-64 relative border border-white/5 animate-slide-up" style="animation-delay: 0.1s"><canvas id="mainChart"></canvas></div><h3 class="text-sm font-bold text-gray-300 mb-3 px-2">æœ€æ–°å‹•æ…‹</h3><div class="space-y-3 pb-20 animate-slide-up" style="animation-delay: 0.2s">${records.slice(0, 5).map(renderCard).join('')}</div>`;
            setTimeout(() => renderChart(stats.sources), 100);
        }

        function renderListView(container, type) {
            const groups = getGroupedData(type);
            const years = Object.keys(groups).sort().reverse();
            const now = new Date(); const currentYear = String(now.getFullYear()); const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            let html = `<div class="flex justify-between items-center mb-4 animate-fade-in"><h2 class="text-xl font-bold flex items-center gap-2">${getIcon(type)} ${getTitle(type)}</h2><button onclick="openEntry('${type}', 'æ–°å¢è¨˜éŒ„')" class="bg-neon-blue/20 text-neon-blue px-4 py-2 rounded-xl text-sm font-bold border border-neon-blue/30 active:scale-95 transition-transform">+ æ–°å¢</button></div>`;
            if (years.length === 0) html += `<div class="text-center py-20 text-gray-500"><i class="fa-solid fa-box-open text-4xl mb-3"></i><p>æš«ç„¡è³‡æ–™</p></div>`;
            else {
                html += `<div class="space-y-4 pb-20">`;
                years.forEach(year => {
                    const isCurrentYear = year === currentYear;
                    html += `<details class="group" ${isCurrentYear ? 'open' : ''}><summary class="flex items-center justify-between p-3 glass-panel rounded-xl mb-2 text-neon-blue font-bold tracking-wide select-none"><span>${year} å¹´</span><i class="fa-solid fa-chevron-down rotate-icon transition-transform duration-300 group-open:rotate-180"></i></summary><div class="pl-2 border-l-2 border-white/10 ml-3 space-y-4">`;
                    const months = Object.keys(groups[year]).sort((a,b)=>b-a);
                    months.forEach(month => {
                        const isCurrentMonth = isCurrentYear && month === currentMonth;
                        html += `<details class="group/inner" ${isCurrentMonth ? 'open' : ''}><summary class="flex items-center gap-2 text-sm text-gray-400 font-medium mb-2 py-1 cursor-pointer hover:text-white transition-colors select-none"><i class="fa-solid fa-calendar-days text-xs"></i> ${month} æœˆ</summary><div class="space-y-2 mb-4">${groups[year][month].map(renderCard).join('')}</div></details>`;
                    });
                    html += `</div></details>`;
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        function getTitle(type) { const map = { 'camel': 'é§±é§æ¼†è¨˜éŒ„', 'reels': 'Reels å®£å‚³', 'kwuntong': 'è§€å¡˜è¨˜éŒ„', 'expense': 'å…¥è²¨/æ”¯å‡º', 'income': 'æ‰€æœ‰æ”¶å…¥', 'attendance': 'æ‰“å¡è¨˜éŒ„' }; return map[type] || 'åˆ—è¡¨'; }
        
        function renderCard(r) {
            let icon, color, title, desc, money, extra = ''; const date = r.date || 'N/A'; const clickAttr = `onclick="editRecord('${r.id}')"`;
            if (r.type === 'camel') { icon = 'fa-building'; color = 'text-neon-blue'; title = 'é§±é§æ¼†'; desc = `ä¸Š:${r.upper} ä¸‹:${r.lower}`; money = `+$${Number(r.upper)+Number(r.lower)}`; }
            else if (r.type === 'reels') { icon = 'fa-instagram'; color = 'text-neon-purple'; title = r.content || 'Reels'; desc = 'å½±ç‰‡å®£å‚³'; money = `+$${r.income}`; }
            else if (r.type === 'kwuntong') { icon = 'fa-shop'; color = 'text-neon-yellow'; title = 'è§€å¡˜å»£å ´'; let refAmt = Number(r.refund || 0); desc = `ä¸‹å±¤: $${r.lower}`; money = `+$${r.lower}`; if (refAmt > 0) { desc += ` | <span class="text-red-400">é€€: $${refAmt}</span>`; if (r.refunded) extra = `<span class="ml-2 text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded border border-green-500/30" onclick="event.stopPropagation()">å·²é€€æ¬¾</span>`; else extra = `<button onclick="event.stopPropagation(); confirmRefund('${r.id}')" class="ml-2 text-[10px] bg-red-500/20 text-red-400 px-2 py-0.5 rounded border border-red-500/30 hover:bg-red-500 hover:text-white transition-colors">ç¢ºèªé€€æ¬¾</button>`; } }
            else if (r.type === 'attendance') { icon = 'fa-clock'; color = 'text-neon-green'; title = 'è–ªè³‡'; desc = r.clockIn ? `${r.clockIn}-${r.clockOut}` : r.note; money = `+$${r.amount}`; }
            else { icon = 'fa-cart-shopping'; color = 'text-neon-pink'; title = r.name; desc = r.source; money = `-$${r.amount}`; }
            return `<div class="glass-panel p-3 rounded-xl flex items-center justify-between hover:bg-white/5 transition-colors border border-white/5 relative z-10 cursor-pointer" ${clickAttr}><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center ${color} bg-black/40 shrink-0 shadow-[0_0_10px_rgba(0,0,0,0.5)]"><i class="fa-solid ${icon}"></i></div><div><h4 class="text-sm font-bold text-gray-200">${title} ${extra}</h4><p class="text-[10px] text-gray-500">${date} Â· ${desc}</p></div></div><div class="flex items-center gap-3"><span class="font-bold font-mono ${r.type === 'expense' ? 'text-neon-pink' : 'text-neon-green'}">${money}</span><i class="fa-solid fa-chevron-right text-xs text-gray-600"></i></div></div>`;
        }
        
        async function confirmRefund(id) {
            if(isGuest) return showToast("è¨ªå®¢æ¨¡å¼ç„¡æ³•æ“ä½œ", "info");
            await getUserRef().collection('records').doc(id).update({refunded:true}); showToast("é€€æ¬¾å·²ç¢ºèª","success");
        }
        
        function deleteFromModal() { if(activeEditId) deleteEntry(activeEditId); closeEntry(); }
        function deleteEntry(id) { showConfirm("ç¢ºå®šåˆªé™¤?", async () => { if(isGuest) { records=records.filter(r=>r.id!==id); switchView(currentFilter); showToast("å·²åˆªé™¤","success"); } else { await getUserRef().collection('records').doc(id).delete(); showToast("å·²åˆªé™¤","success"); } }); }
        function editRecord(id) { const r=records.find(i=>i.id===id); if(r) openEntry(r.type, '', r); }
        function formatDateForInput(d) { return d; }
        
        // --- Keypad & Shared ---
        function openKeypad(id) { activeKeypadInput=document.getElementById(id); document.getElementById('custom-keypad').classList.remove('translate-y-full'); }
        function closeKeypad() { document.getElementById('custom-keypad').classList.add('translate-y-full'); activeKeypadInput=null; }
        function kpInput(v) { if(activeKeypadInput){ activeKeypadInput.value+=v; activeKeypadInput.dispatchEvent(new Event('input')); } }
        function kpDel() { if(activeKeypadInput) activeKeypadInput.value=activeKeypadInput.value.slice(0,-1); }
        function getIcon(t) { const map={camel:'fa-building',reels:'fa-instagram',kwuntong:'fa-shop',expense:'fa-cart-shopping',attendance:'fa-clock'}; return `<i class="fa-solid ${map[t]||'fa-list'}"></i>`; }
        function showToast(m, t="info") { const c=document.getElementById('toast-container'), e=document.createElement('div'); e.className=`toast-msg toast-${t}`; e.innerHTML=`<span><i class="fa-solid ${t==='success'?'fa-check':t==='error'?'fa-xmark':'fa-info'} text-lg"></i> ${m}</span>`; c.appendChild(e); setTimeout(()=>{e.style.opacity='0';e.style.transform='translateY(-20px)';setTimeout(()=>e.remove(),300);},3000); }
        let confirmCallback=null; function showConfirm(m, cb) { const md=document.getElementById('custom-confirm'), b=document.getElementById('confirm-box'); document.getElementById('confirm-msg').innerText=m; confirmCallback=cb; md.classList.remove('hidden'); setTimeout(()=>{md.classList.remove('opacity-0');b.classList.remove('scale-90');b.classList.add('scale-100');},10); }
        function closeConfirm(r) { const md=document.getElementById('custom-confirm'), b=document.getElementById('confirm-box'); b.classList.remove('scale-100'); b.classList.add('scale-90'); md.classList.add('opacity-0'); setTimeout(()=>{md.classList.add('hidden'); if(r && confirmCallback) confirmCallback(); confirmCallback=null;},200); }
        document.getElementById('confirm-yes-btn').onclick=()=>closeConfirm(true);

        function openEntry(type, title, editData=null) {
            activeType = type; activeEditId = editData?.id;
            const modal = document.getElementById('entry-modal'); const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerHTML = editData ? `<i class="fa-solid fa-pen"></i> ä¿®æ”¹è¨˜éŒ„` : `<i class="fa-solid fa-pen-to-square"></i> ${title}`;
            document.getElementById('modal-submit-btn').innerText = editData ? "æ›´æ–°" : "å„²å­˜";
            const delBtn = document.getElementById('modal-delete-btn');
            if(editData) delBtn.classList.remove('hidden'); else delBtn.classList.add('hidden');
            
            let dateVal = editData ? editData.date : new Date().toISOString().split('T')[0];
            let html = `<div class="grid grid-cols-1 gap-5"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-neon-blue font-bold rounded">æ—¥æœŸ</label><input id="in-date" type="date" value="${dateVal}" class="glass-input w-full p-4 rounded-xl text-sm"></div>`;
            if(type==='camel') html+=`<div class="grid grid-cols-2 gap-4"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">ä¸Šå±¤</label><input id="in-upper" type="number" value="${editData?.upper||''}" onclick="openKeypad('in-upper')" readonly class="glass-input w-full p-4 rounded-xl"></div><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">ä¸‹å±¤</label><input id="in-lower" type="number" value="${editData?.lower||''}" onclick="openKeypad('in-lower')" readonly class="glass-input w-full p-4 rounded-xl"></div></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">å‚™è¨»</label><input id="in-note" type="text" value="${editData?.note||''}" class="glass-input w-full p-4 rounded-xl"></div>`;
            else if(type==='reels') html+=`<div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">æ”¶å…¥</label><input id="in-income" type="number" value="${editData?.income||25}" onclick="openKeypad('in-income')" readonly class="glass-input w-full p-4 rounded-xl"></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">å…§å®¹</label><input id="in-content" type="text" value="${editData?.content||''}" class="glass-input w-full p-4 rounded-xl"></div>`;
            else if(type==='kwuntong') html+=`<div class="grid grid-cols-2 gap-4"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">ä¸‹å±¤æ”¶å…¥</label><input id="in-lower" type="number" value="${editData?.lower||''}" onclick="openKeypad('in-lower')" readonly class="glass-input w-full p-4 rounded-xl"></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-red-400">é€€æ¬¾é‡‘é¡</label><input id="in-refund" type="number" value="${editData?.refund||''}" onclick="openKeypad('in-refund')" readonly class="glass-input w-full p-4 rounded-xl text-red-300"></div></div>`;
            else if(type==='expense') html+=`<div class="grid grid-cols-2 gap-4"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">é‡‘é¡</label><input id="in-amount" type="number" value="${editData?.amount||''}" onclick="openKeypad('in-amount')" readonly class="glass-input w-full p-4 rounded-xl"></div><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">é …ç›®</label><input id="in-name" type="text" value="${editData?.name||''}" class="glass-input w-full p-4 rounded-xl"></div></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">ä¾†æº</label><input id="in-source" type="text" value="${editData?.source||''}" class="glass-input w-full p-4 rounded-xl mb-2"><div id="modal-source-list" class="flex flex-wrap gap-2"></div></div>`;
            html += `</div>`;
            document.getElementById('modal-form-container').innerHTML = html;
            if(type==='expense') document.getElementById('modal-source-list').innerHTML = customSources.map(s => `<button onclick="document.getElementById('in-source').value='${s}'" class="px-3 py-1 bg-white/5 border border-white/10 rounded-full text-xs">${s}</button>`).join('');
            modal.classList.remove('hidden'); setTimeout(()=>document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            setTimeout(()=>document.getElementById('modal-content').classList.add('scale-100', 'opacity-100'), 10);
        }

        function closeEntry() { const content = document.getElementById('modal-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(()=>document.getElementById('entry-modal').classList.add('hidden'), 300); closeKeypad(); activeEditId=null; }

        function renderChart(s) {
            const ctx=document.getElementById('mainChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
            Chart.defaults.color='#6b7280'; Chart.defaults.borderColor='transparent';
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['é§±é§æ¼†','Reels','è§€å¡˜','è–ªè³‡'], datasets: [{ data: [s.camel, s.reels, s.kwuntong, s.attendance], backgroundColor: ['#00f3ff','#bc13fe','#facc15','#0aff00'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'75%', plugins: { legend: { position:'right', labels:{ usePointStyle:true, color:'white', font:{family:'"Noto Sans TC"'} } } } } });
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                document.getElementById('clock-date').innerText = `${now.getMonth()+1}/${now.getDate()} ${now.toLocaleDateString('zh-HK', {weekday: 'long'})}`;
                if (workStartTime) {
                    const diff = now - workStartTime;
                    const hrs = Math.floor(diff / 3600000), mins = Math.floor((diff % 3600000) / 60000), secs = Math.floor((diff % 60000) / 1000);
                    const elD = document.getElementById('work-duration'); if(elD) elD.innerText = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
                    const el1 = document.getElementById('est-1h'); if(el1) el1.innerText = new Date(now.getTime() + 3600000).toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                    const el2 = document.getElementById('est-2h'); if(el2) el2.innerText = new Date(now.getTime() + 7200000).toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                }
            }, 1000);
        }

        function showAuth() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
        function showApp() { 
            const name=currentUser.displayName||currentUser.email.split('@')[0], avatar=currentUser.photoURL||`https://api.dicebear.com/7.x/identicon/svg?seed=${currentUser.uid}`;
            document.getElementById('user-name').innerText=name; document.getElementById('user-avatar').src=avatar;
            document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden');
            if(isGuest) document.getElementById('guest-banner').classList.remove('hidden'); else document.getElementById('guest-banner').classList.add('hidden');
            setTimeout(()=>document.getElementById('app-container').classList.add('opacity-100'),100); renderView();
        }
        function toggleMode() { isLoginView=!isLoginView; const b=document.getElementById('login-btn'), t=document.querySelector('#auth-screen span[onclick="toggleMode()"]'); if(isLoginView){b.innerText="é€²å…¥ç³»çµ±";t.innerHTML='é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <span class="text-neon-blue font-bold border-b border-neon-blue/50 pb-0.5">é»æ­¤è¨»å†Š</span>';}else{b.innerText="ç«‹å³è¨»å†Š";t.innerHTML='å·²æœ‰å¸³è™Ÿï¼Ÿ <span class="text-neon-purple font-bold border-b border-neon-purple/50 pb-0.5">é»æ­¤ç™»å…¥</span>';} }
        function handleLogin() { const e=document.getElementById('email').value, p=document.getElementById('password').value; if(!e||!p) return showToast("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š","error"); if(isLoginView) auth.signInWithEmailAndPassword(e,p).catch(err=>showToast(err.message,"error")); else auth.createUserWithEmailAndPassword(e,p).then(()=>showToast("è¨»å†ŠæˆåŠŸ","success")).catch(err=>showToast(err.message,"error")); }
        function handleGoogleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast("Google ç™»å…¥å¤±æ•—","error")); }
        function handleGuest() { isGuest=true; currentUser={uid:'guest',displayName:'è¨ªå®¢',email:'guest@temp.com'}; records=[{id:'1',type:'camel',upper:100,lower:150,date:'2024-10-24',createdAt:{seconds:Date.now()/1000}}]; showApp(); }
        function handleLogout() { showConfirm("ç¢ºå®šç™»å‡ºï¼Ÿ",()=>{ if(isGuest){isGuest=false;records=[];currentUser=null;showAuth();}else{if(unsubscribe)unsubscribe();auth.signOut();} }); }

        init();
    </script>
</body>
</html>


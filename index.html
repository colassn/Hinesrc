<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>騫記錄專用網站</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        mono: ['"Orbitron"', 'monospace']
                    },
                    colors: {
                        neon: { blue: '#00f3ff', purple: '#bc13fe', pink: '#ff0055', green: '#0aff00', yellow: '#facc15' },
                        glass: { 100: 'rgba(255, 255, 255, 0.05)', 200: 'rgba(255, 255, 255, 0.1)' },
                        dark: { bg: '#050511' }
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'accordion-down': 'accordionDown 0.3s ease-out forwards',
                        'keypad-slide': 'keypadSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'neon-pulse': 'neonPulse 2s infinite'
                    },
                    keyframes: {
                        popIn: { from: { opacity: 0, transform: 'scale(0.9) translateY(20px)' }, to: { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        accordionDown: { from: { opacity: 0, transform: 'translateY(-10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        keypadSlide: { from: { transform: 'translateY(100%)' }, to: { transform: 'translateY(0)' } },
                        neonPulse: { '0%, 100%': { boxShadow: '0 0 10px #00f3ff, 0 0 20px #00f3ff' }, '50%': { boxShadow: '0 0 5px #00f3ff, 0 0 10px #00f3ff' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #050511; color: #ffffff;
            font-family: "Noto Sans TC", sans-serif;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #050511; overflow: hidden; }
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; animation: blob 15s infinite alternate; }
        
        .glass-panel { background: rgba(18, 18, 28, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .glass-input { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.15); color: white; transition: all 0.2s; }
        .glass-input:focus { border-color: #00f3ff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); background: rgba(0, 0, 0, 0.7); outline: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 3D Neon Keypad */
        .keypad-btn {
            background: linear-gradient(145deg, #1e1e2f, #151522);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #e0e0e0; font-family: "Orbitron", monospace; font-size: 1.5rem; font-weight: 700; 
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 5px 5px 10px #0b0b12, -2px -2px 6px #252538;
            transition: all 0.05s ease;
            position: relative; overflow: hidden;
            touch-action: manipulation;
        }
        .keypad-btn::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1), transparent);
            opacity: 0; transition: opacity 0.1s;
        }
        .keypad-btn:active, .keypad-btn.pressed {
            transform: scale(0.95);
            box-shadow: inset 5px 5px 10px #0b0b12, inset -5px -5px 10px #252538;
            color: #00f3ff;
            text-shadow: 0 0 10px #00f3ff;
            border-color: rgba(0, 243, 255, 0.3);
        }
        .keypad-btn:active::before { opacity: 1; }
        .keypad-del { color: #ff0055; }

        #type-switcher {
            display: flex; overflow-x: auto; gap: 16px; padding-bottom: 8px;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
        }
        .type-tab { flex-shrink: 0; scroll-snap-align: center; opacity: 0.5; transition: all 0.3s; filter: grayscale(1); transform: scale(0.95); min-width: 70px; }
        .type-tab.active { opacity: 1; filter: grayscale(0); transform: scale(1.1); text-shadow: 0 0 10px currentColor; }
        
        #toast-container { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 380px; pointer-events: none; }
        .toast-msg { background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(12px); color: white; padding: 14px 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.6); pointer-events: auto; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; animation: pop-in 0.3s; }
        .toast-success i { color: #0aff00; } .toast-error i { color: #ff0055; } .toast-info i { color: #00f3ff; }
        
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ div { animation: accordion-down 0.3s ease-out; }
        .input-flashing { animation: input-flash 0.2s ease-out; }
        @keyframes input-flash { 0% { border-color: #00f3ff; box-shadow: 0 0 15px #00f3ff; } 100% { border-color: rgba(255,255,255,0.1); box-shadow: none; } }
    </style>
</head>
<body class="text-white pb-24 font-sans">

    <div class="bg-animation">
        <div class="bg-blob bg-neon-purple w-96 h-96 top-0 left-0"></div>
        <div class="bg-blob bg-neon-blue w-[30rem] h-[30rem] bottom-0 right-0"></div>
    </div>

    <!-- UI Elements -->
    <div id="toast-container"></div>
    
    <!-- Confirm Dialog -->
    <div id="custom-confirm" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-6 opacity-0 transition-opacity duration-200">
        <div class="glass-panel w-full max-w-xs rounded-3xl p-6 transform scale-90 transition-transform duration-200" id="confirm-box">
            <div class="w-14 h-14 rounded-full bg-neon-pink/10 border border-neon-pink/30 flex items-center justify-center text-neon-pink mb-4 mx-auto shadow-[0_0_20px_rgba(255,0,85,0.2)]">
                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-center mb-2">確認操作</h3>
            <p class="text-gray-400 text-center text-sm mb-6" id="confirm-msg">...</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-medium transition-colors">取消</button>
                <button id="confirm-yes-btn" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-neon-pink to-red-600 text-white font-bold shadow-lg shadow-red-900/50">確定</button>
            </div>
        </div>
    </div>

    <!-- Auth -->
    <div id="auth-screen" class="fixed inset-0 z-50 overflow-y-auto overflow-x-hidden bg-[#050511]">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 py-12">
            <div class="glass-panel w-full max-w-[380px] p-8 rounded-[2.5rem] border-t border-white/20 relative mx-auto shadow-2xl animate-pop-in">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-neon-blue via-neon-purple to-neon-pink"></div>
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-neon-blue to-neon-purple rounded-3xl mx-auto flex items-center justify-center shadow-[0_0_30px_rgba(188,19,254,0.3)] mb-4"><i class="fa-solid fa-robot text-4xl text-white"></i></div>
                    <h1 class="text-2xl font-black tracking-wide">騫記錄專用網站</h1>
                    <p class="text-neon-blue text-xs tracking-widest mt-1 opacity-80 font-mono">V4.6 ATTENDANCE FIX</p>
                </div>
                <div id="login-form" class="space-y-4">
                    <input type="email" id="email" placeholder="電子郵件" class="glass-input w-full p-4 rounded-xl text-base placeholder-gray-500">
                    <input type="password" id="password" placeholder="密碼" class="glass-input w-full p-4 rounded-xl text-base placeholder-gray-500">
                    <button onclick="handleLogin()" id="login-btn" class="w-full py-4 bg-gradient-to-r from-neon-blue to-neon-purple rounded-xl font-bold text-white text-lg shadow-lg active:scale-95 transition-transform hover:shadow-[0_0_20px_rgba(0,243,255,0.4)]">進入系統</button>
                </div>
                <div class="mt-6 text-center text-sm text-gray-400">
                    <span onclick="toggleMode()" class="cursor-pointer hover:text-white transition-colors">還沒有帳號？ <span class="text-neon-blue font-bold border-b border-neon-blue/30 pb-0.5">註冊</span></span>
                </div>
                <div class="mt-8 space-y-3">
                     <button onclick="handleGoogleLogin()" class="w-full py-3 bg-white text-gray-900 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">Google 登入</button>
                    <button onclick="handleGuest()" class="w-full py-3 border border-white/20 text-gray-300 rounded-xl font-medium active:scale-95 transition-transform hover:bg-white/5 group"><i class="fa-solid fa-user-secret mr-2 group-hover:text-neon-green transition-colors"></i>訪客模式</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500">
        
        <div id="guest-banner" class="hidden bg-gradient-to-r from-neon-green/20 to-transparent border-b border-neon-green/30 text-neon-green px-4 py-2 text-xs font-bold text-center"><i class="fa-solid fa-eye mr-2"></i> 訪客模式：資料不保存</div>

        <header class="pt-6 px-6 pb-2">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full p-[2px] bg-gradient-to-r from-neon-blue to-neon-pink shadow-[0_0_15px_rgba(188,19,254,0.4)]"><img id="user-avatar" src="" class="w-full h-full rounded-full bg-gray-900 object-cover"></div>
                    <div><p class="text-[10px] text-neon-blue font-bold tracking-wider uppercase mb-0.5">V4.6 Pro</p><h2 class="text-xl font-bold text-white leading-none tracking-tight" id="user-name">User</h2></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettings()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <div id="dashboard-card" class="glass-panel rounded-[2rem] p-6 relative overflow-hidden group border border-white/10 hover:border-white/20 transition-all">
                <div class="absolute -right-12 -top-12 w-48 h-48 bg-neon-blue/10 blur-3xl rounded-full group-hover:bg-neon-purple/20 transition-colors duration-500"></div>
                <div class="flex justify-between items-start mb-2"><div><p class="text-gray-400 text-xs font-medium mb-1 flex items-center gap-1"><i class="fa-solid fa-coins text-neon-blue"></i> 本月淨利潤</p><h1 class="text-4xl font-black text-white tracking-tight font-mono" id="net-profit">$0</h1></div><div class="text-right"><span class="text-xs font-bold px-2 py-1 rounded bg-white/10 text-white border border-white/5 font-mono" id="profit-margin">0%</span></div></div>
                <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden mt-4"><div id="profit-bar" class="h-full bg-gradient-to-r from-neon-blue to-neon-purple w-0 transition-all duration-1000"></div></div>
            </div>
        </header>

        <main class="px-4 pb-28 relative z-10 max-w-2xl mx-auto mt-4">
            <div id="content-area"></div>
        </main>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 w-full glass-panel h-20 z-30 rounded-t-[2rem] border-t border-white/10 shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
            <div class="flex justify-around items-center h-full max-w-2xl mx-auto px-2 pb-2">
                <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-dashboard"><i class="fa-solid fa-chart-line text-lg mb-1"></i><span class="text-[10px] font-bold">概覽</span></button>
                <button onclick="switchView('camel')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-camel"><i class="fa-solid fa-building text-lg mb-1"></i><span class="text-[10px] font-bold">駱駝漆</span></button>
                <button onclick="switchView('reels')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-reels"><i class="fa-brands fa-instagram text-lg mb-1"></i><span class="text-[10px] font-bold">Reels</span></button>
                <button onclick="switchView('kwuntong')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-kwuntong"><i class="fa-solid fa-shop text-lg mb-1"></i><span class="text-[10px] font-bold">觀塘</span></button>
                <button onclick="switchView('attendance')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-attendance"><i class="fa-solid fa-clock text-lg mb-1"></i><span class="text-[10px] font-bold">打卡</span></button>
                <button onclick="switchView('expense')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-expense"><i class="fa-solid fa-file-invoice-dollar text-lg mb-1"></i><span class="text-[10px] font-bold">入貨</span></button>
            </div>
        </div>

        <!-- Entry Modal -->
        <div id="entry-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity duration-300" onclick="closeEntry()"></div>
            <div class="relative w-full max-w-lg glass-panel rounded-[2rem] p-6 sm:p-8 transform scale-95 opacity-0 transition-all duration-300 shadow-2xl border border-white/10 flex flex-col max-h-[85vh]" id="modal-content">
                <div class="flex items-center mb-6 gap-2 pb-2 border-b border-white/10 w-full" id="type-switcher-container">
                    <div id="type-switcher">
                        <button onclick="switchEntryType('camel')" class="type-tab text-neon-blue flex flex-col items-center"><i class="fa-solid fa-building text-xl mb-1"></i><span class="text-[10px] font-bold">駱駝漆</span></button>
                        <button onclick="switchEntryType('reels')" class="type-tab text-neon-purple flex flex-col items-center"><i class="fa-brands fa-instagram text-xl mb-1"></i><span class="text-[10px] font-bold">Reels</span></button>
                        <button onclick="switchEntryType('kwuntong')" class="type-tab text-neon-yellow flex flex-col items-center"><i class="fa-solid fa-shop text-xl mb-1"></i><span class="text-[10px] font-bold">觀塘</span></button>
                        <button onclick="switchEntryType('expense')" class="type-tab text-neon-pink flex flex-col items-center"><i class="fa-solid fa-cart-shopping text-xl mb-1"></i><span class="text-[10px] font-bold">入貨</span></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto no-scrollbar">
                    <h3 class="text-2xl font-black text-white mb-6 flex items-center justify-center gap-2 text-center" id="modal-title">新增記錄</h3>
                    <div id="modal-form-container" class="space-y-5"></div>
                </div>
                <div class="mt-6 flex flex-col gap-3 justify-center pt-4 border-t border-white/10">
                    <button id="modal-submit-btn" onclick="submitEntry()" class="w-full py-4 bg-white text-black rounded-xl font-bold shadow-lg hover:bg-gray-200 transition-all active:scale-95 text-lg">確認儲存</button>
                    <button id="modal-delete-btn" onclick="deleteFromModal()" class="w-full py-4 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl font-bold hidden hover:bg-red-500/20 transition-all active:scale-95 text-lg">刪除此記錄</button>
                </div>
                <button onclick="closeEntry()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>

        <!-- Keypad -->
        <div id="custom-keypad" class="fixed bottom-0 left-0 w-full glass-panel z-[60] transform translate-y-full transition-transform duration-200 border-t border-white/20 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
            <div class="flex justify-between items-center px-6 py-2 bg-black/40 border-b border-white/5 backdrop-blur-xl">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest font-mono">HINES TACTILE INPUT</span>
                <button onclick="closeKeypad()" class="text-neon-blue font-bold px-4 py-1 rounded-full bg-neon-blue/10 hover:bg-neon-blue hover:text-black transition-colors text-sm"><i class="fa-solid fa-check"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3 p-4 bg-[#0a0a12]">
                <button onclick="kpInput(1, this)" class="keypad-btn h-14">1</button><button onclick="kpInput(2, this)" class="keypad-btn h-14">2</button><button onclick="kpInput(3, this)" class="keypad-btn h-14">3</button>
                <button onclick="kpInput(4, this)" class="keypad-btn h-14">4</button><button onclick="kpInput(5, this)" class="keypad-btn h-14">5</button><button onclick="kpInput(6, this)" class="keypad-btn h-14">6</button>
                <button onclick="kpInput(7, this)" class="keypad-btn h-14">7</button><button onclick="kpInput(8, this)" class="keypad-btn h-14">8</button><button onclick="kpInput(9, this)" class="keypad-btn h-14">9</button>
                <button onclick="kpInput('.', this)" class="keypad-btn h-14">.</button><button onclick="kpInput(0, this)" class="keypad-btn h-14">0</button><button onclick="kpDel(this)" class="keypad-btn h-14 keypad-del"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC2mm7_vjrJMUekBShe3BH6VdoPRt-yZqI", authDomain: "hinesrc-25cee.firebaseapp.com", projectId: "hinesrc-25cee", storageBucket: "hinesrc-25cee.firebasestorage.app", messagingSenderId: "873846921584", appId: "1:873846921584:web:079586988dee370cc957b5", measurementId: "G-TQRKF54G4F" };
        let app, auth, db;
        let currentUser = null, records = [], isGuest = false, currentFilter = 'dashboard';
        let chartInstance = null, unsubscribe = null, isLoginView = true;
        let activeKeypadInput = null, workStartTime = null, activeEditId = null;
        let customSources = ['淘寶', '拼多多', 'Carousell', 'Amazon', 'HKTVMall'];
        let activeType = ''; 

        function init() {
            try {
                app = firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore();
                auth.onAuthStateChanged(user => {
                    if (user && !isGuest) { currentUser = user; showApp(); loadFirebaseData(); loadSettings(); checkAttendanceStatus(); } 
                    else if (!isGuest) { showAuth(); }
                });
                startClock();
            } catch (e) { showToast("系統錯誤: " + e.message, "error"); }
        }

        function getGroupedData(filterType) {
            let filtered = [];
            if (filterType === 'dashboard' || filterType === 'income') filtered = records;
            else filtered = records.filter(r => r.type === filterType);

            const groups = {};
            filtered.forEach(r => {
                let year = '未知', month = '未知';
                if (r.date) {
                    const dateParts = r.date.split('-');
                    if(dateParts.length >= 2) { year = dateParts[0]; month = dateParts[1]; }
                }
                if(!groups[year]) groups[year] = {};
                if(!groups[year][month]) groups[year][month] = [];
                groups[year][month].push(r);
            });
            return groups;
        }

        function calculateStats() {
            let inc = 0, exp = 0, sources = { camel: 0, reels: 0, kwuntong: 0, attendance: 0 };
            records.forEach(r => {
                if(r.type === 'expense') exp += Number(r.amount || 0);
                else {
                    let val = 0;
                    if(r.type === 'camel') val = Number(r.upper || 0) + Number(r.lower || 0);
                    if(r.type === 'reels') val = Number(r.income || 0);
                    if(r.type === 'kwuntong') {
                        val = Number(r.lower || 0); 
                        exp += Number(r.refund || 0); 
                        if (r.refunded) val += Number(r.refund || 0); 
                    }
                    if(r.type === 'attendance') val = Number(r.amount || 0);
                    inc += val;
                    if(sources[r.type] !== undefined) sources[r.type] += val;
                }
            });
            return { inc, exp, net: inc - exp, sources };
        }

        function switchView(view) {
            currentFilter = view;
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-neon-blue', 'active'); el.classList.add('text-gray-500'); });
            const activeNav = document.getElementById(`nav-${view}`);
            if(activeNav) { activeNav.classList.remove('text-gray-500'); activeNav.classList.add('text-neon-blue', 'active'); }
            
            const area = document.getElementById('content-area');
            const stats = calculateStats();
            
            document.getElementById('net-profit').innerText = `$${stats.net}`;
            let margin = stats.inc > 0 ? Math.round(((stats.inc - stats.exp)/stats.inc)*100) : 0;
            document.getElementById('profit-margin').innerText = `${margin}%`;
            document.getElementById('profit-bar').style.width = `${Math.max(0, margin)}%`;

            if (view === 'dashboard') renderDashboard(area, stats);
            else if (view === 'settings') renderSettings(area);
            else if (view === 'attendance') renderAttendance(area);
            else renderListView(area, view);
        }

        function renderDashboard(container, stats) {
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-6 animate-slide-up">
                    <div onclick="switchView('income')" class="glass-panel p-4 rounded-2xl cursor-pointer hover:border-neon-green/50 transition-all active:scale-95"><div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-neon-green shadow-[0_0_8px_#0aff00]"></div><p class="text-xs text-gray-400 font-bold">總收入</p></div><p class="text-lg font-bold text-white tracking-wide font-mono">$${stats.inc}</p></div>
                    <div onclick="switchView('expense')" class="glass-panel p-4 rounded-2xl cursor-pointer hover:border-neon-pink/50 transition-all active:scale-95"><div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-neon-pink shadow-[0_0_8px_#ff0055]"></div><p class="text-xs text-gray-400 font-bold">總入貨</p></div><p class="text-lg font-bold text-white tracking-wide font-mono">$${stats.exp}</p></div>
                </div>
                <div class="glass-panel p-4 rounded-3xl mb-6 h-64 relative border border-white/5 animate-slide-up" style="animation-delay: 0.1s"><canvas id="mainChart"></canvas></div>
                <h3 class="text-sm font-bold text-gray-300 mb-3 px-2">最新動態</h3>
                <div class="space-y-3 pb-20 animate-slide-up" style="animation-delay: 0.2s">${records.slice(0, 5).map(renderCard).join('')}</div>
            `;
            setTimeout(() => renderChart(stats.sources), 100);
        }

        function renderListView(container, type) {
            const groups = getGroupedData(type);
            const years = Object.keys(groups).sort().reverse();
            const now = new Date();
            const currentYear = String(now.getFullYear());
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');

            let html = `
                <div class="flex justify-between items-center mb-4 animate-fade-in">
                    <h2 class="text-xl font-bold flex items-center gap-2">${getIcon(type)} ${getTitle(type)}</h2>
                    <button onclick="openEntry('${type}', '新增記錄')" class="bg-neon-blue/20 text-neon-blue px-4 py-2 rounded-xl text-sm font-bold border border-neon-blue/30 active:scale-95 transition-transform">+ 新增</button>
                </div>
            `;
            if (years.length === 0) {
                html += `<div class="text-center py-20 text-gray-500"><i class="fa-solid fa-box-open text-4xl mb-3"></i><p>暫無資料</p></div>`;
            } else {
                html += `<div class="space-y-4 pb-20">`;
                years.forEach(year => {
                    const isCurrentYear = year === currentYear;
                    html += `
                    <details class="group" ${isCurrentYear ? 'open' : ''}>
                        <summary class="flex items-center justify-between p-3 glass-panel rounded-xl mb-2 text-neon-blue font-bold tracking-wide select-none">
                            <span>${year} 年</span>
                            <i class="fa-solid fa-chevron-down rotate-icon transition-transform duration-300 group-open:rotate-180"></i>
                        </summary>
                        <div class="pl-2 border-l-2 border-white/10 ml-3 space-y-4">`;
                            const months = Object.keys(groups[year]).sort((a,b)=>b-a);
                            months.forEach(month => {
                                const isCurrentMonth = isCurrentYear && month === currentMonth;
                                html += `
                                <details class="group/inner" ${isCurrentMonth ? 'open' : ''}>
                                    <summary class="flex items-center gap-2 text-sm text-gray-400 font-medium mb-2 py-1 cursor-pointer hover:text-white transition-colors select-none">
                                        <i class="fa-solid fa-calendar-days text-xs"></i> ${month} 月
                                    </summary>
                                    <div class="space-y-2 mb-4">
                                        ${groups[year][month].map(renderCard).join('')}
                                    </div>
                                </details>`;
                            });
                    html += `</div></details>`;
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        function getTitle(type) { const map = { 'camel': '駱駝漆記錄', 'reels': 'Reels 宣傳', 'kwuntong': '觀塘記錄', 'expense': '入貨/支出', 'income': '所有收入', 'attendance': '打卡記錄' }; return map[type] || '列表'; }
        
        function renderCard(r) {
            let icon, color, title, desc, money, extra = '';
            const date = r.date || 'N/A';
            const clickAttr = `onclick="editRecord('${r.id}')"`;

            if (r.type === 'camel') {
                icon = 'fa-building'; color = 'text-neon-blue'; title = '駱駝漆';
                const total = Number(r.upper) + Number(r.lower); desc = `上:${r.upper} 下:${r.lower}`; money = `+$${total}`;
            } else if (r.type === 'reels') {
                icon = 'fa-instagram'; color = 'text-neon-purple'; title = r.content || 'Reels'; desc = '影片宣傳'; money = `+$${r.income}`;
            } else if (r.type === 'kwuntong') {
                icon = 'fa-shop'; color = 'text-neon-yellow'; title = '觀塘廣場';
                let refAmt = Number(r.refund || 0);
                desc = `下層: $${r.lower}`; money = `+$${r.lower}`;
                if (refAmt > 0) {
                    desc += ` | <span class="text-red-400">退: $${refAmt}</span>`;
                    if (r.refunded) extra = `<span class="ml-2 text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded border border-green-500/30" onclick="event.stopPropagation()">已退款</span>`;
                    else extra = `<button onclick="event.stopPropagation(); confirmRefund('${r.id}')" class="ml-2 text-[10px] bg-red-500/20 text-red-400 px-2 py-0.5 rounded border border-red-500/30 hover:bg-red-500 hover:text-white transition-colors">確認退款</button>`;
                }
            } else if (r.type === 'attendance') {
                icon = 'fa-clock'; color = 'text-neon-green'; title = '薪資';
                desc = r.clockIn ? `${r.clockIn}-${r.clockOut}` : r.note; money = `+$${r.amount}`;
            } else {
                icon = 'fa-cart-shopping'; color = 'text-neon-pink'; title = r.name; desc = r.source; money = `-$${r.amount}`;
            }

            return `
            <div class="glass-panel p-3 rounded-xl flex items-center justify-between hover:bg-white/5 transition-colors border border-white/5 relative z-10 cursor-pointer" ${clickAttr}>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center ${color} bg-black/40 shrink-0 shadow-[0_0_10px_rgba(0,0,0,0.5)]"><i class="fa-solid ${icon}"></i></div>
                    <div>
                        <h4 class="text-sm font-bold text-gray-200">${title} ${extra}</h4>
                        <p class="text-[10px] text-gray-500">${date} · ${desc}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-bold font-mono ${r.type === 'expense' ? 'text-neon-pink' : 'text-neon-green'}">${money}</span>
                    <i class="fa-solid fa-chevron-right text-xs text-gray-600"></i>
                </div>
            </div>`;
        }

        function getIcon(t) { const map={camel:'fa-building',reels:'fa-instagram',kwuntong:'fa-shop',expense:'fa-cart-shopping',attendance:'fa-clock'}; return `<i class="fa-solid ${map[t]||'fa-list'}"></i>`; }
        function showToast(m, t="info") { const c=document.getElementById('toast-container'), e=document.createElement('div'); e.className=`toast-msg toast-${t}`; e.innerHTML=`<span><i class="fa-solid ${t==='success'?'fa-check':t==='error'?'fa-xmark':'fa-info'} text-lg"></i> ${m}</span>`; c.appendChild(e); setTimeout(()=>{e.style.opacity='0';e.style.transform='translateY(-20px)';setTimeout(()=>e.remove(),300);},3000); }
        let confirmCallback=null; function showConfirm(m, cb) { const md=document.getElementById('custom-confirm'), b=document.getElementById('confirm-box'); document.getElementById('confirm-msg').innerText=m; confirmCallback=cb; md.classList.remove('hidden'); setTimeout(()=>{md.classList.remove('opacity-0');b.classList.remove('scale-90');b.classList.add('scale-100');},10); }
        function closeConfirm(r) { const md=document.getElementById('custom-confirm'), b=document.getElementById('confirm-box'); b.classList.remove('scale-100'); b.classList.add('scale-90'); md.classList.add('opacity-0'); setTimeout(()=>{md.classList.add('hidden'); if(r && confirmCallback) confirmCallback(); confirmCallback=null;},200); }
        document.getElementById('confirm-yes-btn').onclick=()=>closeConfirm(true);

        function openEntry(type, title, editData=null) {
            activeType = type; activeEditId = editData?.id;
            const modal = document.getElementById('entry-modal');
            const content = document.getElementById('modal-content');
            
            document.getElementById('modal-title').innerHTML = editData ? `<i class="fa-solid fa-pen"></i> 修改記錄` : `<i class="fa-solid fa-pen-to-square"></i> ${title}`;
            document.getElementById('modal-submit-btn').innerText = editData ? "更新" : "儲存";
            const delBtn = document.getElementById('modal-delete-btn');
            if(editData) delBtn.classList.remove('hidden'); else delBtn.classList.add('hidden');
            
            const switcher = document.getElementById('type-switcher-container');
            if(editData) switcher.classList.add('hidden'); else {
                switcher.classList.remove('hidden');
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                const btnIndex = {camel:0, reels:1, kwuntong:2, expense:3}[type];
                if(btnIndex!==undefined) document.getElementById('type-switcher').children[btnIndex].classList.add('active');
            }

            renderEntryForm(type, editData);
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function switchEntryType(newType) {
            if(activeEditId) return; 
            activeType = newType;
            document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
            const btnIndex = {camel:0, reels:1, kwuntong:2, expense:3}[newType];
            if(btnIndex!==undefined) document.getElementById('type-switcher').children[btnIndex].classList.add('active');
            renderEntryForm(newType, null);
        }

        function renderEntryForm(type, editData) {
            let dateVal = editData ? formatDateForInput(editData.date) : new Date().toISOString().split('T')[0];
            let html = `<div class="grid grid-cols-1 gap-5"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-neon-blue font-bold rounded">日期</label><input id="in-date" type="date" value="${dateVal}" class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-blue transition-colors"></div>`;
            
            if(type==='camel') html+=`<div class="grid grid-cols-2 gap-4"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">上層</label><input id="in-upper" type="number" value="${editData?.upper||''}" onclick="openKeypad('in-upper')" readonly class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-blue cursor-pointer"></div><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">下層</label><input id="in-lower" type="number" value="${editData?.lower||''}" onclick="openKeypad('in-lower')" readonly class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-blue cursor-pointer"></div></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">備註</label><input id="in-note" type="text" value="${editData?.note||''}" placeholder="選填" class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-blue"></div>`;
            else if(type==='reels') html+=`<div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">收入</label><input id="in-income" type="number" value="${editData?.income||25}" onclick="openKeypad('in-income')" readonly class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-purple cursor-pointer"></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">內容</label><input id="in-content" type="text" value="${editData?.content||''}" placeholder="例如：情人節宣傳" class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-purple"></div>`;
            else if(type==='kwuntong') html+=`<div class="grid grid-cols-2 gap-4"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">下層收入 (計入收入)</label><input id="in-lower" type="number" value="${editData?.lower||''}" onclick="openKeypad('in-lower')" readonly class="glass-input w-full p-4 rounded-xl text-sm focus:border-orange-500 cursor-pointer"></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-red-400">退款金額 (計入支出)</label><input id="in-refund" type="number" value="${editData?.refund||''}" placeholder="如有" onclick="openKeypad('in-refund')" readonly class="glass-input w-full p-4 rounded-xl text-sm focus:border-red-500 text-red-300 cursor-pointer"></div></div>`;
            else if(type==='expense') html+=`<div class="grid grid-cols-2 gap-4"><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">金額</label><input id="in-amount" type="number" value="${editData?.amount||''}" onclick="openKeypad('in-amount')" readonly class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-pink cursor-pointer"></div><div class="relative group"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">項目</label><input id="in-name" type="text" value="${editData?.name||''}" placeholder="例如：公仔" class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-pink"></div></div><div class="relative group mt-4"><label class="absolute -top-2 left-3 bg-[#1d1d2b] px-1 text-[10px] text-gray-400">來源</label><input id="in-source" type="text" value="${editData?.source||''}" placeholder="輸入來源" class="glass-input w-full p-4 rounded-xl text-sm focus:border-neon-pink mb-3"><div class="flex justify-center gap-3" id="modal-source-list"></div></div>`;
            
            html += `</div>`;
            document.getElementById('modal-form-container').innerHTML = html;
            if(type==='expense') document.getElementById('modal-source-list').innerHTML = customSources.map(s => `<button onclick="document.getElementById('in-source').value='${s}'" class="px-3 py-1 bg-white/5 border border-white/10 rounded-full text-xs hover:bg-neon-pink hover:text-white transition-colors">${s}</button>`).join('');
        }

        function closeEntry() { 
            const content = document.getElementById('modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(()=>document.getElementById('entry-modal').classList.add('hidden'), 300); 
            closeKeypad(); activeEditId=null; 
        }
        
        async function submitEntry() {
            const btn = document.getElementById('modal-submit-btn');
            const dateVal = document.getElementById('in-date').value;
            if (!dateVal) { showToast("請選擇日期", "error"); return; }

            const displayDate = dateVal; // Use raw YYYY-MM-DD string

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';
            btn.disabled = true;

            let data = { type: activeType, date: displayDate };
            if(!activeEditId && !isGuest) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();

            try {
                if(activeType==='camel') { data.upper = document.getElementById('in-upper').value; data.lower = document.getElementById('in-lower').value; data.note = document.getElementById('in-note').value; }
                else if(activeType==='reels') { data.income = document.getElementById('in-income').value; data.content = document.getElementById('in-content').value; }
                else if(activeType==='kwuntong') { 
                    data.lower = document.getElementById('in-lower').value; 
                    data.refund = document.getElementById('in-refund').value;
                    if(!activeEditId) data.refunded = false; 
                }
                else if(activeType==='expense') { data.amount = document.getElementById('in-amount').value; data.name = document.getElementById('in-name').value; data.source = document.getElementById('in-source').value; }

                if(isGuest) {
                    if(activeEditId) { const idx=records.findIndex(r=>r.id===activeEditId); if(idx!==-1) records[idx]={...records[idx],...data}; }
                    else { data.id='g_'+Date.now(); records.unshift(data); }
                    showToast("已儲存 (訪客)", "success");
                } else {
                    const ref = db.collection('users').doc(currentUser.uid).collection('records');
                    if(activeEditId) await ref.doc(activeEditId).update(data); else await ref.add(data);
                    showToast("已同步雲端", "success");
                    setTimeout(loadFirebaseData, 500); // Force Refresh
                }
                closeEntry(); 
                if(isGuest) switchView(currentFilter);
            } catch(e) {
                console.error(e);
                showToast("儲存失敗: " + e.message, "error");
            } finally {
                btn.innerHTML = '確認儲存';
                btn.disabled = false;
            }
        }

        function deleteFromModal() { if(activeEditId) deleteEntry(activeEditId); closeEntry(); }
        function deleteEntry(id) {
            showConfirm("確定刪除?", async () => {
                if(isGuest) { records=records.filter(r=>r.id!==id); switchView(currentFilter); showToast("已刪除","success"); }
                else { await db.collection('users').doc(currentUser.uid).collection('records').doc(id).delete(); showToast("已刪除","success"); }
            });
        }
        function editRecord(id) { const r=records.find(i=>i.id===id); if(r) openEntry(r.type, '', r); }
        function formatDateForInput(d) { return d; }
        async function confirmRefund(id) { if(isGuest)return; await db.collection('users').doc(currentUser.uid).collection('records').doc(id).update({refunded:true}); showToast("退款已確認","success"); }

        function openKeypad(id) { activeKeypadInput=document.getElementById(id); document.getElementById('custom-keypad').classList.remove('translate-y-full'); }
        function closeKeypad() { document.getElementById('custom-keypad').classList.add('translate-y-full'); activeKeypadInput=null; }
        function kpInput(v, btn) { 
            if(activeKeypadInput){ 
                activeKeypadInput.value+=v; activeKeypadInput.dispatchEvent(new Event('input')); 
                btn.classList.add('pressed'); setTimeout(()=>btn.classList.remove('pressed'),100); 
                if(navigator.vibrate)navigator.vibrate(15); 
                activeKeypadInput.parentElement.classList.add('input-flashing');
                setTimeout(()=>activeKeypadInput.parentElement.classList.remove('input-flashing'),200);
            } 
        }
        function kpDel(btn) { if(activeKeypadInput){ activeKeypadInput.value=activeKeypadInput.value.slice(0,-1); activeKeypadInput.dispatchEvent(new Event('input')); if(btn){btn.classList.add('pressed');setTimeout(()=>btn.classList.remove('pressed'),100);} if(navigator.vibrate)navigator.vibrate(20); } }
        
        function renderChart(s) {
            const ctx=document.getElementById('mainChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
            Chart.defaults.color='#6b7280'; Chart.defaults.borderColor='transparent';
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['駱駝漆','Reels','觀塘','薪資'], datasets: [{ data: [s.camel, s.reels, s.kwuntong, s.attendance], backgroundColor: ['#00f3ff','#bc13fe','#facc15','#0aff00'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'75%', plugins: { legend: { position:'right', labels:{ usePointStyle:true, color:'white', font:{family:'"Noto Sans TC"'} } } } } });
        }

        // --- Other Views ---
        function renderAttendance(container) {
            // Updated to be simpler and directly show status from global state check
            container.innerHTML = `
                <div class="glass-panel p-6 rounded-3xl w-full max-w-sm mx-auto border border-white/10 relative overflow-hidden text-center animate-slide-up">
                    <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-business-time text-6xl text-white"></i></div>
                    <p class="text-gray-400 text-sm mb-1 font-mono text-left" id="clock-date">--/--</p>
                    <h1 class="text-5xl font-black text-white font-mono tracking-wider text-left mb-4" id="clock-time">00:00</h1>
                    <div id="active-work-info" class="hidden text-left space-y-3 border-t border-white/10 pt-4 mt-2">
                        <div><p class="text-xs text-gray-500">已上班時間</p><p class="text-2xl text-neon-green font-bold font-mono" id="work-duration">00:00:00</p></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-[10px] text-gray-500">1小時後下班</p><p class="text-sm text-white font-mono" id="est-1h">--:--</p></div>
                            <div><p class="text-[10px] text-gray-500">2小時後下班</p><p class="text-sm text-white font-mono" id="est-2h">--:--</p></div>
                        </div>
                    </div>
                    <p class="text-gray-500 text-xs mt-4 font-bold text-left" id="work-status-text">準備就緒</p>
                </div>
                <div class="grid grid-cols-1 gap-4 max-w-xs mx-auto mt-6 animate-slide-up" style="animation-delay: 0.1s">
                    <button onclick="startWork()" id="btn-clock-in" class="py-4 bg-gradient-to-r from-neon-green to-emerald-600 rounded-2xl font-black text-white text-lg shadow-lg active:scale-95 transition-transform"><i class="fa-solid fa-play mr-2"></i> 上班打卡</button>
                    <button onclick="endWork()" id="btn-clock-out" class="hidden py-4 bg-gradient-to-r from-neon-pink to-red-600 rounded-2xl font-black text-white text-lg shadow-lg active:scale-95 transition-transform"><i class="fa-solid fa-stop mr-2"></i> 下班結算</button>
                </div>
                <div class="mt-8 animate-slide-up" style="animation-delay: 0.2s">
                    <h3 class="text-sm font-bold text-gray-300 mb-3 px-2">歷史打卡</h3>
                    <div id="attendance-list" class="space-y-2 pb-20"></div>
                </div>
            `;
            const attRecords = records.filter(r => r.type === 'attendance').slice(0, 10);
            document.getElementById('attendance-list').innerHTML = attRecords.length ? attRecords.map(renderCard).join('') : `<div class="text-center text-xs text-gray-500">無記錄</div>`;
            
            // Force re-check status to update UI immediately
            checkAttendanceStatus();
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl animate-fade-in">
                    <h3 class="text-neon-blue font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-list"></i> 自定義入貨來源</h3>
                    <div id="source-list" class="flex flex-wrap gap-2 mb-4"></div>
                    <div class="flex gap-2">
                        <input id="new-source-input" type="text" placeholder="新增來源" class="glass-input flex-1 p-3 rounded-xl text-sm">
                        <button onclick="addSource()" class="px-4 bg-neon-blue/20 text-neon-blue rounded-xl"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            `;
            renderSourceList();
        }

        // --- Auth & Core Logic (Same as before) ---
        function showAuth() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
        function showApp() { 
            const name=currentUser.displayName||currentUser.email.split('@')[0], avatar=currentUser.photoURL||`https://api.dicebear.com/7.x/identicon/svg?seed=${currentUser.uid}`;
            document.getElementById('user-name').innerText=name; document.getElementById('user-avatar').src=avatar;
            document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden');
            if(isGuest) document.getElementById('guest-banner').classList.remove('hidden'); else document.getElementById('guest-banner').classList.add('hidden');
            setTimeout(()=>document.getElementById('app-container').classList.add('opacity-100'),100); renderView();
        }
        function toggleMode() { isLoginView=!isLoginView; const b=document.getElementById('login-btn'), t=document.querySelector('#auth-screen span[onclick="toggleMode()"]'); if(isLoginView){b.innerText="進入系統";t.innerHTML='還沒有帳號？ <span class="text-neon-blue font-bold border-b border-neon-blue/50 pb-0.5">點此註冊</span>';}else{b.innerText="立即註冊";t.innerHTML='已有帳號？ <span class="text-neon-purple font-bold border-b border-neon-purple/50 pb-0.5">點此登入</span>';} }
        function handleLogin() { const e=document.getElementById('email').value, p=document.getElementById('password').value; if(!e||!p) return showToast("請輸入完整資訊","error"); if(isLoginView) auth.signInWithEmailAndPassword(e,p).catch(err=>showToast(err.message,"error")); else auth.createUserWithEmailAndPassword(e,p).then(()=>showToast("註冊成功","success")).catch(err=>showToast(err.message,"error")); }
        function handleGoogleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast("Google 登入失敗","error")); }
        function handleGuest() { isGuest=true; currentUser={uid:'guest',displayName:'訪客',email:'guest@temp.com'}; records=[{id:'1',type:'camel',upper:100,lower:150,date:'2024-10-24',createdAt:{seconds:Date.now()/1000}}]; showApp(); }
        function handleLogout() { showConfirm("確定登出？",()=>{ if(isGuest){isGuest=false;records=[];currentUser=null;showAuth();}else{if(unsubscribe)unsubscribe();auth.signOut();} }); }

        function loadFirebaseData() {
            if(unsubscribe) unsubscribe();
            const ref = db.collection('users').doc(currentUser.uid).collection('records');
            unsubscribe = ref.onSnapshot(snap => {
                records = snap.docs.map(d => ({id: d.id, ...d.data()}));
                records.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                // Smart Reload
                if(currentFilter === 'attendance') renderAttendance(document.getElementById('content-area'));
                else if(currentFilter === 'settings') renderSettings(document.getElementById('content-area'));
                else if(currentFilter === 'dashboard') renderDashboard(document.getElementById('content-area'), calculateStats());
                else renderListView(document.getElementById('content-area'), currentFilter);
            });
        }
        function loadSettings() {
            if(isGuest) return;
            db.collection('users').doc(currentUser.uid).get().then(doc => { if(doc.exists && doc.data().customSources) customSources = doc.data().customSources; });
        }

        // --- Clock ---
        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                document.getElementById('clock-date').innerText = `${now.getMonth()+1}/${now.getDate()} ${now.toLocaleDateString('zh-HK', {weekday: 'long'})}`;
                if (workStartTime) {
                    const diff = now - workStartTime;
                    const hrs = Math.floor(diff / 3600000), mins = Math.floor((diff % 3600000) / 60000), secs = Math.floor((diff % 60000) / 1000);
                    const elDuration = document.getElementById('work-duration');
                    if(elDuration) elDuration.innerText = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
                    
                    const oneHr = new Date(workStartTime.getTime() + 3600000);
                    const twoHr = new Date(workStartTime.getTime() + 7200000);
                    const el1 = document.getElementById('est-1h');
                    const el2 = document.getElementById('est-2h');
                    if(el1) el1.innerText = oneHr.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                    if(el2) el2.innerText = twoHr.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                }
            }, 1000);
        }
        function checkAttendanceStatus() {
            if(isGuest) return;
            db.collection('users').doc(currentUser.uid).collection('attendance').doc('current').onSnapshot(doc => {
                const statusText = document.getElementById('work-status-text');
                const btnIn = document.getElementById('btn-clock-in');
                const btnOut = document.getElementById('btn-clock-out');
                const activeInfo = document.getElementById('active-work-info');
                
                // Elements might be null if view switched
                if (!statusText) return; 

                if (doc.exists) {
                    workStartTime = doc.data().startTime.toDate();
                    statusText.innerText = `上班中 (${workStartTime.getHours()}:${String(workStartTime.getMinutes()).padStart(2,'0')} 開始)`;
                    statusText.className = "text-neon-green text-xs mt-4 font-bold animate-pulse text-left";
                    btnIn.classList.add('hidden'); btnOut.classList.remove('hidden'); activeInfo.classList.remove('hidden');
                } else {
                    workStartTime = null;
                    statusText.innerText = "準備就緒"; statusText.className = "text-gray-500 text-xs mt-4 font-bold text-left";
                    btnIn.classList.remove('hidden'); btnOut.classList.add('hidden'); activeInfo.classList.add('hidden');
                }
            });
        }
        async function startWork() { if(isGuest) { showToast("訪客模式無法打卡", "info"); return; } try { await db.collection('users').doc(currentUser.uid).collection('attendance').doc('current').set({ startTime: firebase.firestore.FieldValue.serverTimestamp() }); showToast("上班打卡成功", "success"); } catch(e) { showToast("打卡失敗", "error"); } }
        async function endWork() {
            if(isGuest) return;
            try {
                const docRef = db.collection('users').doc(currentUser.uid).collection('attendance').doc('current');
                const doc = await docRef.get();
                if(!doc.exists) return;
                const start = doc.data().startTime.toDate(), end = new Date();
                const diffMs = end - start, diffMins = diffMs / 1000 / 60;
                const blocks = Math.ceil(diffMins / 30);
                const pay = blocks * 25, hours = (blocks * 0.5).toFixed(1);
                
                const sStr = start.toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'});
                const eStr = end.toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'});

                const recordData = { type: 'attendance', date: `${end.getFullYear()}-${String(end.getMonth()+1).padStart(2,'0')}-${String(end.getDate()).padStart(2,'0')}`, amount: pay, note: `工時: ${hours}小時`, clockIn: sStr, clockOut: eStr, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                await db.collection('users').doc(currentUser.uid).collection('records').add(recordData);
                await docRef.delete(); workStartTime = null; showToast(`下班！薪資 $${pay} 已記錄`, "success");
            } catch(e) { console.error(e); showToast("結算失敗", "error"); }
        }

        init();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>騫記錄專用網站</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        mono: ['"Orbitron"', 'monospace']
                    },
                    colors: {
                        neon: { blue: '#00f3ff', purple: '#bc13fe', pink: '#ff0055', green: '#0aff00', yellow: '#facc15' },
                        glass: { 100: 'rgba(255, 255, 255, 0.05)', 200: 'rgba(255, 255, 255, 0.1)' },
                        dark: { bg: '#050511' }
                    },
                    animation: {
                        'pop-in': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'accordion-down': 'accordionDown 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards'
                    },
                    keyframes: {
                        popIn: { from: { opacity: 0, transform: 'scale(0.9) translateY(20px)' }, to: { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        accordionDown: { from: { opacity: 0, transform: 'translateY(-10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        slideUp: { from: { transform: 'translateY(20px)', opacity: 0 }, to: { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #050511; color: #ffffff;
            font-family: "Noto Sans TC", sans-serif;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #050511; overflow: hidden; }
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; animation: blob 15s infinite alternate; }
        @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 100% { transform: translate(20px, 20px) scale(1.1); } }
        
        .glass-panel { background: rgba(18, 18, 28, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .glass-input { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.15); color: white; transition: all 0.2s; }
        .glass-input:focus { border-color: #00f3ff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); background: rgba(0, 0, 0, 0.7); outline: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 3D Neon Keypad */
        .keypad-btn {
            background: linear-gradient(145deg, #1e1e2f, #151522);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #e0e0e0; font-family: "Orbitron", monospace; font-size: 1.5rem; font-weight: 700; 
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 5px 5px 10px #0b0b12, -2px -2px 6px #252538;
            transition: all 0.05s ease;
            position: relative; overflow: hidden;
            touch-action: manipulation;
        }
        .keypad-btn:active, .keypad-btn.pressed {
            transform: scale(0.95);
            box-shadow: inset 5px 5px 10px #0b0b12, inset -5px -5px 10px #252538;
            color: #00f3ff;
            text-shadow: 0 0 10px #00f3ff;
            border-color: rgba(0, 243, 255, 0.3);
        }
        .keypad-del { color: #ff0055; }

        /* Scrollable Type Switcher */
        #type-switcher {
            display: flex; overflow-x: auto; gap: 16px; padding-bottom: 8px;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
        }
        .type-tab { flex-shrink: 0; scroll-snap-align: center; opacity: 0.5; transition: all 0.3s; filter: grayscale(1); transform: scale(0.95); min-width: 70px; }
        .type-tab.active { opacity: 1; filter: grayscale(0); transform: scale(1.1); text-shadow: 0 0 10px currentColor; }
        
        #toast-container { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 380px; pointer-events: none; }
        .toast-msg { background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(12px); color: white; padding: 14px 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.6); pointer-events: auto; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; animation: pop-in 0.3s; }
        .toast-success i { color: #0aff00; } .toast-error i { color: #ff0055; } .toast-info i { color: #00f3ff; }
        
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ div { animation: accordion-down 0.3s ease-out; }
        .input-flashing { animation: input-flash 0.2s ease-out; }
        @keyframes input-flash { 0% { border-color: #00f3ff; box-shadow: 0 0 15px #00f3ff; } 100% { border-color: rgba(255,255,255,0.1); box-shadow: none; } }
    </style>
</head>
<body class="text-white pb-24 font-sans">

    <div class="bg-animation">
        <div class="bg-blob bg-neon-purple w-96 h-96 top-0 left-0"></div>
        <div class="bg-blob bg-neon-blue w-[30rem] h-[30rem] bottom-0 right-0"></div>
    </div>

    <!-- UI Elements -->
    <div id="toast-container"></div>
    
    <div id="custom-confirm" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-6 opacity-0 transition-opacity duration-200">
        <div class="glass-panel w-full max-w-xs rounded-3xl p-6 transform scale-90 transition-transform duration-200" id="confirm-box">
            <div class="w-14 h-14 rounded-full bg-neon-pink/10 border border-neon-pink/30 flex items-center justify-center text-neon-pink mb-4 mx-auto shadow-[0_0_20px_rgba(255,0,85,0.2)]"><i class="fa-solid fa-triangle-exclamation text-2xl"></i></div>
            <h3 class="text-lg font-bold text-center mb-2">確認操作</h3>
            <p class="text-gray-400 text-center text-sm mb-6" id="confirm-msg">...</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-medium transition-colors">取消</button>
                <button id="confirm-yes-btn" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-neon-pink to-red-600 text-white font-bold shadow-lg shadow-red-900/50">確定</button>
            </div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 overflow-y-auto bg-[#050511]">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 py-12">
            <div class="glass-panel w-full max-w-[380px] p-8 rounded-[2.5rem] border-t border-white/20 relative mx-auto shadow-2xl animate-pop-in">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-neon-blue to-neon-purple rounded-3xl mx-auto flex items-center justify-center shadow-[0_0_30px_rgba(188,19,254,0.3)] mb-4"><i class="fa-solid fa-robot text-4xl text-white"></i></div>
                    <h1 class="text-2xl font-black tracking-wide">騫記錄專用網站</h1>
                    <p class="text-neon-blue text-xs tracking-widest mt-1 opacity-80 font-mono">V5.0 FINAL</p>
                </div>
                
                <div class="space-y-4">
                     <button onclick="handleGoogleLogin()" class="w-full py-4 bg-white text-gray-900 rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-transform shadow-lg"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6">使用 Google 登入</button>
                    <button onclick="handleGuest()" class="w-full py-4 border border-white/20 text-gray-300 rounded-xl font-medium active:scale-95 transition-transform hover:bg-white/5 group"><i class="fa-solid fa-user-secret mr-2 group-hover:text-neon-green transition-colors"></i>訪客模式試用</button>
                </div>
                <p class="text-[10px] text-gray-600 mt-8 text-center">SECURE CLOUD STORAGE</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500">
        
        <div id="guest-banner" class="hidden bg-gradient-to-r from-neon-green/20 to-transparent border-b border-neon-green/30 text-neon-green px-4 py-2 text-xs font-bold text-center"><i class="fa-solid fa-eye mr-2"></i> 訪客模式：資料不保存</div>

        <header class="pt-6 px-6 pb-2">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full p-[2px] bg-gradient-to-r from-neon-blue to-neon-pink shadow-[0_0_15px_rgba(188,19,254,0.4)]"><img id="user-avatar" src="" class="w-full h-full rounded-full bg-gray-900 object-cover"></div>
                    <div><p class="text-[10px] text-neon-blue font-bold tracking-wider uppercase mb-0.5">V5.0 System</p><h2 class="text-xl font-bold text-white leading-none tracking-tight" id="user-name">User</h2></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettings()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <!-- Dashboard Card (Visible only on non-attendance pages) -->
            <div id="dashboard-card" class="glass-panel rounded-[2rem] p-6 relative overflow-hidden group border border-white/10 hover:border-white/20 transition-all">
                <div class="absolute -right-12 -top-12 w-48 h-48 bg-neon-blue/10 blur-3xl rounded-full group-hover:bg-neon-purple/20 transition-colors duration-500"></div>
                <div class="flex justify-between items-start mb-2"><div><p class="text-gray-400 text-xs font-medium mb-1 flex items-center gap-1"><i class="fa-solid fa-coins text-neon-blue"></i> 本月淨利潤</p><h1 class="text-4xl font-black text-white tracking-tight font-mono" id="net-profit">$0</h1></div><div class="text-right"><span class="text-xs font-bold px-2 py-1 rounded bg-white/10 text-white border border-white/5 font-mono" id="profit-margin">0%</span></div></div>
                <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden mt-4"><div id="profit-bar" class="h-full bg-gradient-to-r from-neon-blue to-neon-purple w-0 transition-all duration-1000"></div></div>
            </div>
        </header>

        <main class="px-4 pb-28 relative z-10 max-w-2xl mx-auto mt-4">
            <div id="content-area"></div>
        </main>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 w-full glass-panel h-20 z-30 rounded-t-[2rem] border-t border-white/10 shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
            <div class="flex justify-around items-center h-full max-w-2xl mx-auto px-2 pb-2">
                <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-dashboard"><i class="fa-solid fa-chart-line text-lg mb-1"></i><span class="text-[10px] font-bold">概覽</span></button>
                <button onclick="switchView('camel')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-camel"><i class="fa-solid fa-building text-lg mb-1"></i><span class="text-[10px] font-bold">駱駝</span></button>
                <button onclick="switchView('reels')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-reels"><i class="fa-brands fa-instagram text-lg mb-1"></i><span class="text-[10px] font-bold">Reels</span></button>
                <button onclick="switchView('kwuntong')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-kwuntong"><i class="fa-solid fa-shop text-lg mb-1"></i><span class="text-[10px] font-bold">觀塘</span></button>
                <button onclick="switchView('attendance')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-attendance"><i class="fa-solid fa-clock text-lg mb-1"></i><span class="text-[10px] font-bold">打卡</span></button>
                <button onclick="switchView('expense')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-500 transition-colors" id="nav-expense"><i class="fa-solid fa-cart-shopping text-lg mb-1"></i><span class="text-[10px] font-bold">入貨</span></button>
            </div>
        </div>

        <!-- Entry Modal -->
        <div id="entry-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity duration-300" onclick="closeEntry()"></div>
            <div class="relative w-full max-w-lg glass-panel rounded-[2rem] p-6 sm:p-8 transform scale-95 opacity-0 transition-all duration-300 shadow-2xl border border-white/10 flex flex-col max-h-[85vh]" id="modal-content">
                
                <div class="flex items-center mb-6 gap-2 pb-2 border-b border-white/10 w-full" id="type-switcher-container">
                    <div id="type-switcher">
                        <button onclick="switchEntryType('camel')" class="type-tab text-neon-blue flex flex-col items-center"><i class="fa-solid fa-building text-xl mb-1"></i><span class="text-[10px] font-bold">駱駝漆</span></button>
                        <button onclick="switchEntryType('reels')" class="type-tab text-neon-purple flex flex-col items-center"><i class="fa-brands fa-instagram text-xl mb-1"></i><span class="text-[10px] font-bold">Reels</span></button>
                        <button onclick="switchEntryType('kwuntong')" class="type-tab text-neon-yellow flex flex-col items-center"><i class="fa-solid fa-shop text-xl mb-1"></i><span class="text-[10px] font-bold">觀塘</span></button>
                        <button onclick="switchEntryType('expense')" class="type-tab text-neon-pink flex flex-col items-center"><i class="fa-solid fa-cart-shopping text-xl mb-1"></i><span class="text-[10px] font-bold">入貨</span></button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto no-scrollbar">
                    <h3 class="text-2xl font-black text-white mb-6 flex items-center justify-center gap-2 text-center" id="modal-title">新增記錄</h3>
                    <div id="modal-form-container" class="space-y-5"></div>
                </div>

                <div class="mt-6 flex flex-col gap-3 justify-center pt-4 border-t border-white/10">
                    <button id="modal-submit-btn" onclick="submitEntry()" class="w-full py-4 bg-white text-black rounded-xl font-bold shadow-lg hover:bg-gray-200 transition-all active:scale-95 text-lg">確認儲存</button>
                    <button id="modal-delete-btn" onclick="deleteFromModal()" class="w-full py-4 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl font-bold hidden hover:bg-red-500/20 transition-all active:scale-95 text-lg">刪除此記錄</button>
                </div>
                
                <button onclick="closeEntry()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>

        <!-- Haptic Keypad -->
        <div id="custom-keypad" class="fixed bottom-0 left-0 w-full glass-panel z-[60] transform translate-y-full transition-transform duration-200 border-t border-white/20 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
            <div class="flex justify-between items-center px-6 py-2 bg-black/40 border-b border-white/5 backdrop-blur-xl">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest font-mono">HINES TACTILE INPUT</span>
                <button onclick="closeKeypad()" class="text-neon-blue font-bold px-4 py-1 rounded-full bg-neon-blue/10 hover:bg-neon-blue hover:text-black transition-colors text-sm"><i class="fa-solid fa-check"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3 p-4 bg-[#0a0a12]">
                <button onclick="kpInput(1, this)" class="keypad-btn h-14">1</button><button onclick="kpInput(2, this)" class="keypad-btn h-14">2</button><button onclick="kpInput(3, this)" class="keypad-btn h-14">3</button>
                <button onclick="kpInput(4, this)" class="keypad-btn h-14">4</button><button onclick="kpInput(5, this)" class="keypad-btn h-14">5</button><button onclick="kpInput(6, this)" class="keypad-btn h-14">6</button>
                <button onclick="kpInput(7, this)" class="keypad-btn h-14">7</button><button onclick="kpInput(8, this)" class="keypad-btn h-14">8</button><button onclick="kpInput(9, this)" class="keypad-btn h-14">9</button>
                <button onclick="kpInput('.', this)" class="keypad-btn h-14">.</button><button onclick="kpInput(0, this)" class="keypad-btn h-14">0</button><button onclick="kpDel(this)" class="keypad-btn h-14 keypad-del"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>

    </div>

    <script>
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hines-pro-os';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let app, auth, db;
        let currentUser = null, records = [], isGuest = false, currentFilter = 'dashboard';
        let unsubscribe = null, activeKeypadInput = null, activeEditId = null, activeType = 'camel';
        let workStartTime = null;
        let customSources = ['淘寶', '拼多多', 'Carousell', 'Amazon', 'HKTVMall'];

        function init() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                auth.onAuthStateChanged(user => {
                    if (user && !isGuest) {
                        currentUser = user;
                        showApp();
                    } else if (!isGuest) {
                        showAuth();
                    }
                });
                startClock();
            } catch (e) { console.error(e); showToast("初始化失敗", "error"); }
        }

        // --- Data ---
        function getUserRef() { return db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid); }

        function loadData() {
            if(unsubscribe) unsubscribe();
            if(isGuest) return;
            const ref = getUserRef().collection('records');
            unsubscribe = ref.onSnapshot(snap => {
                records = snap.docs.map(d => ({id: d.id, ...d.data()}));
                records.sort((a,b) => new Date(b.date||0) - new Date(a.date||0));
                refreshCurrentView();
            });
            getUserRef().get().then(doc => { if(doc.exists && doc.data().customSources) customSources = doc.data().customSources; });
            checkAttendanceStatus();
        }

        function refreshCurrentView() { switchView(currentFilter); }

        // --- Auth ---
        function showAuth() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
        function showApp() { 
            document.getElementById('user-name').innerText = currentUser.displayName || "User";
            document.getElementById('user-avatar').src = currentUser.photoURL || "";
            document.getElementById('auth-screen').classList.add('hidden'); 
            document.getElementById('app-container').classList.remove('hidden');
            setTimeout(()=>document.getElementById('app-container').classList.add('opacity-100'),100);
            if(isGuest) document.getElementById('guest-banner').classList.remove('hidden');
            else loadData();
            refreshCurrentView();
        }
        function handleGoogleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast(e.message,'error')); }
        function handleGuest() { isGuest=true; currentUser={uid:'guest',displayName:'訪客'}; records=[]; showApp(); }
        function handleLogout() { auth.signOut(); location.reload(); }

        // --- View Logic ---
        function switchView(view) {
            currentFilter = view;
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-neon-blue', 'active'); el.classList.add('text-gray-500'); });
            const activeNav = document.getElementById(`nav-${view}`);
            if(activeNav) { activeNav.classList.remove('text-gray-500'); activeNav.classList.add('text-neon-blue', 'active'); }

            const area = document.getElementById('content-area');
            const dashHeader = document.getElementById('dashboard-header');
            
            if(view === 'attendance') dashHeader.classList.add('hidden'); else { dashHeader.classList.remove('hidden'); updateStats(); }
            area.innerHTML = ''; 

            if (view === 'dashboard') renderDashboard(area);
            else if (view === 'settings') renderSettings(area);
            else if (view === 'attendance') renderAttendance(area);
            else renderListView(area, view);
        }

        function updateStats() {
            let inc = 0, exp = 0;
            records.forEach(r => {
                if(r.type === 'expense') exp += Number(r.amount || 0);
                else if(r.type === 'kwuntong') {
                    inc += Number(r.lower || 0);
                    exp += Number(r.refund || 0);
                    if(r.refunded) inc += Number(r.refund || 0);
                } else {
                    if(r.type === 'camel') inc += Number(r.upper || 0) + Number(r.lower || 0);
                    if(r.type === 'reels') inc += Number(r.income || 0);
                    if(r.type === 'attendance') inc += Number(r.amount || 0);
                }
            });
            document.getElementById('net-profit').innerText = `$${inc - exp}`;
            let margin = inc > 0 ? Math.round(((inc - exp)/inc)*100) : 0;
            document.getElementById('profit-margin').innerText = `${margin}%`;
            document.getElementById('profit-bar').style.width = `${Math.max(0, margin)}%`;
        }

        function renderDashboard(container) {
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-6 animate-slide-up">
                   <div onclick="switchView('income')" class="glass-panel p-4 rounded-xl text-center"><p class="text-xs text-gray-400">總收入</p><p class="text-xl font-bold text-neon-green">收入統計</p></div>
                   <div onclick="switchView('expense')" class="glass-panel p-4 rounded-xl text-center"><p class="text-xs text-gray-400">總入貨</p><p class="text-xl font-bold text-neon-pink">支出統計</p></div>
                </div>
                <h3 class="text-sm font-bold text-gray-400 mb-3 px-2">最新動態</h3>
                <div class="space-y-3 pb-20">${records.slice(0, 5).map(renderCard).join('')}</div>
            `;
        }

        function renderListView(container, type) {
            let filtered = type === 'income' ? records.filter(r => r.type !== 'expense') : records.filter(r => r.type === type);
            const groups = {};
            filtered.forEach(r => {
                const d = r.date || "9999-01-01"; const y = d.split('-')[0]; const m = d.split('-')[1];
                if(!groups[y]) groups[y] = {}; if(!groups[y][m]) groups[y][m] = []; groups[y][m].push(r);
            });
            let html = `<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white capitalize">${getTitle(type)}</h2><button onclick="openEntry('${type}')" class="bg-neon-blue/20 text-neon-blue px-4 py-1 rounded-full text-xs border border-neon-blue/50">+ 新增</button></div>`;
            const years = Object.keys(groups).sort().reverse();
            if(years.length === 0) html += `<div class="text-center py-10 text-gray-500">暫無資料</div>`;
            else {
                years.forEach(y => {
                    const isCurrentYear = y === new Date().getFullYear().toString();
                    html += `<details ${isCurrentYear?'open':''} class="mb-4"><summary class="glass-panel p-3 rounded-xl font-bold text-neon-blue mb-2 flex justify-between"><span>${y} 年</span><i class="fa-solid fa-chevron-down"></i></summary><div class="pl-2">`;
                    Object.keys(groups[y]).sort().reverse().forEach(m => {
                        html += `<div class="mb-2"><p class="text-xs text-gray-400 mb-1 ml-1">${m} 月</p><div class="space-y-2 border-l-2 border-white/10 pl-2">${groups[y][m].map(renderCard).join('')}</div></div>`;
                    });
                    html += `</div></details>`;
                });
            }
            container.innerHTML = html;
        }

        function renderAttendance(container) {
            container.innerHTML = `
                <div class="glass-panel p-6 rounded-3xl text-center mb-6 border border-white/10 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-clock text-6xl"></i></div>
                    <p class="text-gray-400 text-sm mb-1 font-mono text-left" id="clock-date">--/--</p>
                    <h1 class="text-5xl font-black text-white font-mono tracking-wider text-left mb-2" id="clock-time">00:00</h1>
                    <div id="active-work-info" class="hidden text-left space-y-3 border-t border-white/10 pt-4 mt-2">
                        <div><p class="text-xs text-gray-500">已上班時間</p><p class="text-2xl text-neon-green font-bold font-mono" id="work-duration">00:00:00</p></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-[10px] text-gray-500">1小時後下班</p><p class="text-sm text-white font-mono" id="est-1h">--:--</p></div>
                            <div><p class="text-[10px] text-gray-500">2小時後下班</p><p class="text-sm text-white font-mono" id="est-2h">--:--</p></div>
                        </div>
                    </div>
                    <p class="text-left text-xs font-bold text-gray-500 mt-4" id="work-status-text">讀取中...</p>
                </div>
                <div class="grid grid-cols-1 gap-4 max-w-xs mx-auto mb-8">
                    <button onclick="startWork()" id="btn-clock-in" class="py-4 bg-gradient-to-r from-neon-green to-emerald-600 rounded-xl font-black text-white text-lg shadow-lg active:scale-95 hidden">上班打卡</button>
                    <button onclick="endWork()" id="btn-clock-out" class="py-4 bg-gradient-to-r from-neon-pink to-red-600 rounded-xl font-black text-white text-lg shadow-lg active:scale-95 hidden">下班結算</button>
                </div>
                <h3 class="text-sm font-bold text-gray-400 mb-3 px-2">最近打卡</h3>
                <div class="space-y-2 pb-20">${records.filter(r => r.type === 'attendance').slice(0, 10).map(renderCard).join('')}</div>
            `;
            checkAttendanceStatus();
        }

        // --- Core Functions ---
        function getTitle(t) { const map = { 'camel': '駱駝漆', 'reels': 'Reels', 'kwuntong': '觀塘', 'expense': '入貨', 'income': '收入', 'attendance': '打卡' }; return map[t] || '列表'; }
        function renderCard(r) {
            let title = r.type;
            if(r.type==='camel') title = '駱駝漆';
            if(r.type==='reels') title = r.content || 'Reels';
            if(r.type==='kwuntong') title = '觀塘廣場';
            if(r.type==='expense') title = r.name || '入貨';
            if(r.type==='attendance') title = '薪資';
            return `<div class="glass-panel p-3 rounded-xl flex justify-between mb-2 cursor-pointer" onclick="openEntry('${r.type}', {id:'${r.id}',...records.find(x=>x.id=='${r.id}')})"><div><h4 class="font-bold text-sm">${title}</h4><p class="text-xs text-gray-400">${r.date}</p></div><div class="text-right"><i class="fa-solid fa-chevron-right text-xs"></i></div></div>`;
        }
        
        function openEntry(type, record=null) {
            activeType = type; activeEditId = record?.id;
            const modal = document.getElementById('entry-modal');
            document.getElementById('modal-title').innerText = record ? "修改記錄" : "新增記錄";
            document.getElementById('modal-submit-btn').innerText = record ? "更新" : "儲存";
            document.getElementById('modal-delete-btn').classList.toggle('hidden', !record);
            
            const switcher = document.getElementById('type-switcher-container');
            if(record) switcher.classList.add('hidden'); else {
                switcher.classList.remove('hidden');
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                const btnIndex = {camel:0, reels:1, kwuntong:2, expense:3}[type];
                if(btnIndex!==undefined) document.getElementById('type-switcher').children[btnIndex].classList.add('active');
            }
            renderEntryForm(type, record);
            modal.classList.remove('hidden');
        }

        function switchEntryType(type) { if(activeEditId) return; activeType = type; renderEntryForm(type, null); document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active')); const btnIndex = {camel:0, reels:1, kwuntong:2, expense:3}[type]; if(btnIndex!==undefined) document.getElementById('type-switcher').children[btnIndex].classList.add('active'); }

        function renderEntryForm(type, data) {
            const container = document.getElementById('modal-form-container');
            let today = new Date().toISOString().split('T')[0];
            let dateVal = data ? data.date : today;
            let html = `<div class="mb-4"><label class="text-xs text-gray-400 ml-1">日期</label><input id="in-date" type="date" value="${dateVal}" class="glass-input w-full p-3 rounded-xl mt-1"></div>`;
            if(type==='camel') html += `<div class="flex gap-3 mb-3"><div><label class="text-xs text-gray-400">上層</label><input id="in-upper" type="number" value="${data?.upper||''}" onclick="openKeypad('in-upper')" readonly class="glass-input w-full p-3 rounded-xl"></div><div><label class="text-xs text-gray-400">下層</label><input id="in-lower" type="number" value="${data?.lower||''}" onclick="openKeypad('in-lower')" readonly class="glass-input w-full p-3 rounded-xl"></div></div><div class="mb-3"><label class="text-xs text-gray-400">備註</label><input id="in-note" type="text" value="${data?.note||''}" class="glass-input w-full p-3 rounded-xl"></div>`;
            else if(type==='reels') html += `<div class="mb-3"><label class="text-xs text-gray-400">收入</label><input id="in-income" type="number" value="${data?.income||25}" onclick="openKeypad('in-income')" readonly class="glass-input w-full p-3 rounded-xl"></div><div class="mb-3"><label class="text-xs text-gray-400">內容</label><input id="in-content" type="text" value="${data?.content||''}" class="glass-input w-full p-3 rounded-xl"></div>`;
            else if(type==='kwuntong') html += `<div class="mb-3"><label class="text-xs text-gray-400">下層收入</label><input id="in-lower" type="number" value="${data?.lower||''}" onclick="openKeypad('in-lower')" readonly class="glass-input w-full p-3 rounded-xl text-neon-yellow"></div><div class="mb-3"><label class="text-xs text-gray-400">退款金額</label><input id="in-refund" type="number" value="${data?.refund||''}" onclick="openKeypad('in-refund')" readonly class="glass-input w-full p-3 rounded-xl text-red-400"></div>`;
            else if(type==='expense') html += `<div class="flex gap-3 mb-3"><div><label class="text-xs text-gray-400">金額</label><input id="in-amount" type="number" value="${data?.amount||''}" onclick="openKeypad('in-amount')" readonly class="glass-input w-full p-3 rounded-xl text-neon-pink"></div><div><label class="text-xs text-gray-400">項目</label><input id="in-name" type="text" value="${data?.name||''}" class="glass-input w-full p-3 rounded-xl"></div></div><div class="mb-3"><label class="text-xs text-gray-400">來源</label><input id="in-source" type="text" value="${data?.source||''}" class="glass-input w-full p-3 rounded-xl mb-2"><div class="flex gap-2 flex-wrap">${customSources.map(s=>`<button onclick="document.getElementById('in-source').value='${s}'" class="text-xs bg-white/5 border border-white/10 px-2 py-1 rounded-full">${s}</button>`).join('')}</div></div>`;
            container.innerHTML = html;
        }

        function closeEntry() { document.getElementById('entry-modal').classList.add('hidden'); closeKeypad(); activeEditId=null; }

        async function submitEntry() {
            const btn = document.getElementById('modal-submit-btn'); btn.innerHTML = '處理中...'; btn.disabled = true;
            const date = document.getElementById('in-date').value;
            let data = { type: activeType, date };
            if(!activeEditId && !isGuest) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            if(activeType==='camel') { data.upper = document.getElementById('in-upper').value; data.lower = document.getElementById('in-lower').value; data.note = document.getElementById('in-note').value; }
            else if(activeType==='reels') { data.income = document.getElementById('in-income').value; data.content = document.getElementById('in-content').value; }
            else if(activeType==='kwuntong') { data.lower = document.getElementById('in-lower').value; data.refund = document.getElementById('in-refund').value; if(!activeEditId) data.refunded = false; }
            else if(activeType==='expense') { data.amount = document.getElementById('in-amount').value; data.name = document.getElementById('in-name').value; data.source = document.getElementById('in-source').value; }

            try {
                if(isGuest) {
                    if(activeEditId) { const i=records.findIndex(r=>r.id===activeEditId); if(i>-1) records[i]={...records[i], ...data}; }
                    else { data.id='g_'+Date.now(); records.unshift(data); }
                    showToast("已儲存 (訪客)", "success");
                } else {
                    const ref = getUserRef().collection('records');
                    if(activeEditId) await ref.doc(activeEditId).update(data); else await ref.add(data);
                    showToast("已同步", "success");
                }
                closeEntry(); refreshCurrentView();
            } catch(e) { showToast("失敗: "+e.message, "error"); } finally { btn.innerHTML = '確認儲存'; btn.disabled = false; }
        }

        function deleteFromModal() { if(activeEditId) deleteEntry(activeEditId); closeEntry(); }
        function deleteEntry(id) {
            showConfirm("確定刪除?", async () => {
                if(isGuest) { records=records.filter(r=>r.id!==id); refreshCurrentView(); showToast("已刪除","success"); }
                else { await getUserRef().collection('records').doc(id).delete(); showToast("已刪除","success"); }
            });
        }
        function closeConfirm(r) { const md=document.getElementById('custom-confirm'); md.classList.add('hidden'); if(r && confirmCallback) confirmCallback(); confirmCallback=null; }
        function showConfirm(m, cb) { document.getElementById('confirm-msg').innerText=m; confirmCallback=cb; document.getElementById('custom-confirm').classList.remove('hidden'); }
        document.getElementById('confirm-yes-btn').onclick=()=>closeConfirm(true);
        function showToast(m, t) { const el=document.createElement('div'); el.className=`toast-msg border-${t==='error'?'red':'green'}-500`; el.innerHTML=`<span>${m}</span>`; document.getElementById('toast-container').appendChild(el); setTimeout(()=>el.remove(),3000); }
        function openKeypad(id) { activeKeypadInput=document.getElementById(id); document.getElementById('custom-keypad').classList.remove('translate-y-full'); }
        function closeKeypad() { document.getElementById('custom-keypad').classList.add('translate-y-full'); activeKeypadInput=null; }
        function kpInput(v) { if(activeKeypadInput) { activeKeypadInput.value+=v; activeKeypadInput.dispatchEvent(new Event('input')); }}
        function kpDel() { if(activeKeypadInput) activeKeypadInput.value=activeKeypadInput.value.slice(0,-1); }
        
        function startClock() { setInterval(()=>{ const d = new Date(); document.getElementById('clock-time').innerText=d.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'}); document.getElementById('clock-date').innerText=`${d.getMonth()+1}/${d.getDate()}`; if(workStartTime){ const diff=d-workStartTime; const hrs=Math.floor(diff/3600000); const mins=Math.floor((diff%3600000)/60000); const secs=Math.floor((diff%60000)/1000); document.getElementById('work-duration').innerText=`${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`; document.getElementById('est-1h').innerText=new Date(d.getTime()+3600000).toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'}); document.getElementById('est-2h').innerText=new Date(d.getTime()+7200000).toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'}); } }, 1000); }
        
        function checkAttendanceStatus() {
            if(isGuest) return;
            getUserRef().collection('attendance').doc('current').onSnapshot(doc => {
                const btnIn = document.getElementById('btn-clock-in');
                const btnOut = document.getElementById('btn-clock-out');
                const status = document.getElementById('work-status-text');
                const info = document.getElementById('active-work-info');
                if(!btnIn) return;
                if(doc.exists) {
                    workStartTime = doc.data().startTime.toDate();
                    btnIn.classList.add('hidden'); btnOut.classList.remove('hidden'); info.classList.remove('hidden');
                    status.innerText = "工作中..."; status.classList.add('text-neon-green');
                } else {
                    workStartTime = null;
                    btnIn.classList.remove('hidden'); btnOut.classList.add('hidden'); info.classList.add('hidden');
                    status.innerText = "準備就緒"; status.classList.remove('text-neon-green');
                }
            });
        }
        async function startWork() { if(isGuest) return; await getUserRef().collection('attendance').doc('current').set({startTime: firebase.firestore.FieldValue.serverTimestamp()}); }
        async function endWork() {
            if(isGuest) return;
            const ref = getUserRef().collection('attendance').doc('current');
            const snap = await ref.get();
            if(snap.exists) {
                const start = snap.data().startTime.toDate();
                const now = new Date();
                const diff = (now - start) / 1000 / 60; 
                const blocks = Math.ceil(diff / 30);
                const pay = blocks * 25;
                const hours = (blocks * 0.5).toFixed(1);
                await getUserRef().collection('records').add({
                    type: 'attendance', date: now.toISOString().split('T')[0], amount: pay,
                    clockIn: start.toLocaleTimeString(), clockOut: now.toLocaleTimeString(),
                    note: `工時: ${hours}小時`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await ref.delete();
                showToast(`薪資 $${pay} 已入帳`, 'success');
            }
        }
        init();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-Hant" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>騫記錄專用網站</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans TC"', '"Inter"', 'sans-serif'], mono: ['"Orbitron"', 'monospace'] },
                    colors: { dark: { bg: '#000000', card: '#1c1c1e' }, brand: { 500: '#0a84ff' } },
                    animation: { 
                        'pop-in': 'popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards'
                    },
                    keyframes: {
                        popIn: { from: { opacity: 0, transform: 'translate(-50%, -40%) scale(0.95)' }, to: { opacity: 1, transform: 'translate(-50%, -50%) scale(1)' } },
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        slideUp: { from: { transform: 'translateY(100%)' }, to: { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #000000; color: #f2f2f7; -webkit-tap-highlight-color: transparent; overflow-x: hidden; user-select: none; }
        
        /* Glass UI */
        .glass { background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); }
        .glass-card { background: #1c1c1e; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.1s; }
        .glass-card:active { transform: scale(0.98); background: #2c2c2e; }
        
        /* Inputs */
        .modern-input { background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; outline: none; pointer-events: auto; }
        .modern-input:focus { border-color: #0a84ff; background: #1c1c1e; }
        
        /* Buttons */
        .btn-action { cursor: pointer; user-select: none; touch-action: manipulation; position: relative; z-index: 10; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.95); }

        /* Keypad */
        .keypad-btn { background: #2c2c2e; border-radius: 10px; color: white; font-family: 'Orbitron'; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 0 #000; }
        .keypad-btn:active { background: #48484a; transform: translateY(2px); box-shadow: none; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
        .toast { background: rgba(50,50,50,0.9); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: fadeIn 0.3s; pointer-events: auto; display: flex; align-items: center; gap: 8px; }

        /* Scrollable Category Tabs */
        .cat-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 4px; scroll-snap-type: x mandatory; }
        .cat-item { 
            flex-shrink: 0; scroll-snap-align: center; border-radius: 16px; padding: 12px 20px; 
            font-size: 13px; font-weight: 600; color: #a1a1aa; background: #2c2c2e; border: 1px solid #3f3f46; 
            transition: 0.2s; white-space: nowrap; display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 80px;
        }
        .cat-item i { font-size: 18px; margin-bottom: 2px; }
        .cat-item.active { background: #0a84ff; color: white; border-color: #0a84ff; box-shadow: 0 4px 15px rgba(10, 132, 255, 0.4); transform: scale(1.05); }

        /* Nav */
        .nav-item { color: #8e8e93; transition: color 0.2s; cursor: pointer; }
        .nav-item.active { color: #0a84ff; }
        .nav-item.active i { transform: translateY(-2px); }

        /* Centered Modal Styles */
        .center-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 450px; background: #141416; border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.1);
            opacity: 0; z-index: 60;
        }
        .center-modal.show { animation: pop-in 0.3s forwards; }

        /* Details Accordion */
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ div { animation: fadeIn 0.3s; }

        .z-50 { z-index: 50; } .z-60 { z-index: 60; } .z-70 { z-index: 70; }
    </style>
</head>
<body class="font-sans pb-28">

    <div id="toast-container"></div>
    
    <!-- Confirm Dialog -->
    <div id="custom-confirm" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center p-6">
        <div class="glass-card w-full max-w-xs p-6 text-center">
            <h3 class="text-lg font-bold mb-2 text-white">確認操作</h3>
            <p class="text-gray-400 text-sm mb-6" id="confirm-msg">...</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3 rounded-xl bg-white/10 btn-action text-gray-300">取消</button>
                <button id="confirm-yes-btn" class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold btn-action">確定</button>
            </div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-6 overflow-y-auto">
        <div class="w-full max-w-sm space-y-6 text-center animate-fade-in my-auto">
            <div class="w-24 h-24 bg-[#1c1c1e] rounded-3xl mx-auto flex items-center justify-center shadow-2xl border border-[#333]">
                <i class="fa-solid fa-cube text-5xl text-[#0a84ff]"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">騫記錄專用網站</h1>
                <p class="text-gray-500 text-sm mt-2 font-mono">V6.9.2 FIXED</p>
            </div>

            <div class="space-y-4 pt-4 w-full">
                <button onclick="handleGuest()" class="w-full py-4 bg-[#0a84ff] text-white rounded-2xl font-bold text-lg btn-action shadow-lg shadow-blue-900/30">
                    <i class="fa-solid fa-bolt mr-2"></i> 訪客試用
                </button>
                <button onclick="handleGoogleLogin()" class="w-full py-4 bg-white text-black rounded-2xl font-bold text-base btn-action flex items-center justify-center gap-2">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Google 登入
                </button>
            </div>
            <p class="text-[10px] text-gray-600 mt-6">訪客模式資料儲存於本機</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden opacity-0 transition-opacity duration-300">
        
        <header class="px-5 pt-12 pb-4 bg-black/90 backdrop-blur-md sticky top-0 z-20 border-b border-[#1c1c1e]">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-[#0a84ff] font-bold tracking-widest uppercase mb-1" id="system-status">LOCAL MODE</p>
                    <h1 class="text-2xl font-bold text-white" id="user-name">訪客</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshData()" class="w-10 h-10 rounded-full bg-[#1c1c1e] flex items-center justify-center text-gray-400 btn-action"><i class="fa-solid fa-rotate-right"></i></button>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-[#1c1c1e] flex items-center justify-center text-red-500 btn-action"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <main class="px-4 pt-6 pb-32" id="content-area">
            <!-- Dynamic Content -->
        </main>

        <div class="fixed bottom-0 left-0 w-full glass z-40 pb-safe">
            <div class="flex justify-around items-center h-20 max-w-md mx-auto px-1">
                <button onclick="switchView('dashboard')" class="flex-1 flex flex-col items-center justify-center h-full text-gray-500 transition-colors btn-action nav-item active" id="nav-dashboard"><i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[9px]">概覽</span></button>
                <button onclick="switchView('camel')" class="flex-1 flex flex-col items-center justify-center h-full text-gray-500 transition-colors btn-action nav-item" id="nav-camel"><i class="fa-solid fa-building text-xl mb-1"></i><span class="text-[9px]">駱駝</span></button>
                <button onclick="switchView('reels')" class="flex-1 flex flex-col items-center justify-center h-full text-gray-500 transition-colors btn-action nav-item" id="nav-reels"><i class="fa-brands fa-instagram text-xl mb-1"></i><span class="text-[9px]">Reels</span></button>
                <button onclick="switchView('kwuntong')" class="flex-1 flex flex-col items-center justify-center h-full text-gray-500 transition-colors btn-action nav-item" id="nav-kwuntong"><i class="fa-solid fa-shop text-xl mb-1"></i><span class="text-[9px]">觀塘</span></button>
                <button onclick="switchView('attendance')" class="flex-1 flex flex-col items-center justify-center h-full text-gray-500 transition-colors btn-action nav-item" id="nav-attendance"><i class="fa-solid fa-clock text-xl mb-1"></i><span class="text-[9px]">打卡</span></button>
                <button onclick="switchView('expense')" class="flex-1 flex flex-col items-center justify-center h-full text-gray-500 transition-colors btn-action nav-item" id="nav-expense"><i class="fa-solid fa-cart-shopping text-xl mb-1"></i><span class="text-[9px]">入貨</span></button>
            </div>
        </div>

        <!-- Entry Modal (Floating Center) -->
        <div id="entry-modal" class="fixed inset-0 z-60 hidden flex items-center justify-center">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeEntry()"></div>
            <div class="center-modal p-6 flex flex-col max-h-[85vh]" id="modal-content">
                
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white" id="modal-title">新增記錄</h3>
                    <button onclick="closeEntry()" class="text-gray-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>

                <!-- Scrollable Switcher with Icons -->
                <div class="cat-scroll no-scrollbar mb-6" id="type-switcher">
                    <button onclick="switchEntryType('camel')" class="cat-item"><i class="fa-solid fa-building"></i>駱駝漆</button>
                    <button onclick="switchEntryType('reels')" class="cat-item"><i class="fa-brands fa-instagram"></i>Reels</button>
                    <button onclick="switchEntryType('kwuntong')" class="cat-item"><i class="fa-solid fa-shop"></i>觀塘</button>
                    <button onclick="switchEntryType('expense')" class="cat-item"><i class="fa-solid fa-cart-shopping"></i>入貨</button>
                </div>
                
                <div class="flex-1 overflow-y-auto no-scrollbar space-y-5" id="modal-form-container"></div>
                
                <div class="mt-6 pt-4 border-t border-[#27272a] grid grid-cols-1 gap-3">
                    <button id="modal-submit-btn" onclick="submitEntry()" class="w-full py-4 bg-[#0a84ff] text-white rounded-xl font-bold btn-action shadow-lg">確認儲存</button>
                    <button id="modal-delete-btn" onclick="deleteFromModal()" class="w-full py-3 bg-[#2c2c2e] text-red-500 rounded-xl font-bold btn-action hidden">刪除記錄</button>
                </div>
            </div>
        </div>

        <!-- Keypad -->
        <div id="custom-keypad" class="fixed bottom-0 left-0 w-full bg-[#141416] z-70 transform translate-y-full transition-transform duration-200 rounded-t-3xl shadow-2xl pb-safe">
            <div class="flex justify-between items-center px-6 py-3 border-b border-[#2c2c2e]">
                <span class="text-xs text-gray-500 font-bold tracking-widest">INPUT</span>
                <button onclick="closeKeypad()" class="text-[#0a84ff] font-bold px-3 py-1 bg-[#0a84ff]/10 rounded-lg text-sm">完成</button>
            </div>
            <div class="grid grid-cols-3 gap-2 p-3 bg-[#0a0a0c]">
                <button onclick="kpInput(1)" class="keypad-btn h-14">1</button><button onclick="kpInput(2)" class="keypad-btn h-14">2</button><button onclick="kpInput(3)" class="keypad-btn h-14">3</button>
                <button onclick="kpInput(4)" class="keypad-btn h-14">4</button><button onclick="kpInput(5)" class="keypad-btn h-14">5</button><button onclick="kpInput(6)" class="keypad-btn h-14">6</button>
                <button onclick="kpInput(7)" class="keypad-btn h-14">7</button><button onclick="kpInput(8)" class="keypad-btn h-14">8</button><button onclick="kpInput(9)" class="keypad-btn h-14">9</button>
                <button onclick="kpInput('.')" class="keypad-btn h-14">.</button><button onclick="kpInput(0)" class="keypad-btn h-14">0</button><button onclick="kpDel()" class="keypad-btn h-14 text-red-400"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC2mm7_vjrJMUekBShe3BH6VdoPRt-yZqI", authDomain: "hinesrc-25cee.firebaseapp.com", projectId: "hinesrc-25cee", storageBucket: "hinesrc-25cee.firebasestorage.app", messagingSenderId: "873846921584", appId: "1:873846921584:web:079586988dee370cc957b5", measurementId: "G-TQRKF54G4F" };
        const appId = 'hinesrc-25cee';
        
        let app, auth, db;
        let currentUser = null, records = [], isGuest = false, currentFilter = 'dashboard';
        let unsubscribe = null, activeKeypadInput = null, activeEditId = null, activeType = 'camel';
        let workStartTime = null;
        let customSources = ['淘寶', '拼多多', 'Carousell', 'Amazon', 'HKTVMall'];

        // --- Init Function ---
        function init() {
            try {
                if (!firebase.apps.length) app = firebase.initializeApp(firebaseConfig); else app = firebase.app();
                auth = firebase.auth(); db = firebase.firestore();
                auth.onAuthStateChanged(user => {
                    if (user && !isGuest) { currentUser = user; showApp(); } 
                });
            } catch (e) { console.error("Firebase Init Error", e); }
            startClock();
        }

        // --- Data ---
        function getUserRef() { if(!currentUser) return null; return db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid); }

        function loadData() {
            if(unsubscribe) unsubscribe();
            
            if(isGuest) {
                const saved = localStorage.getItem('hines_records_v6');
                records = saved ? JSON.parse(saved) : [];
                const savedSrc = localStorage.getItem('hines_guest_sources');
                if(savedSrc) customSources = JSON.parse(savedSrc);
                const att = localStorage.getItem('hines_attendance');
                workStartTime = att ? new Date(att) : null;
                refreshCurrentView();
                return;
            }

            const ref = getUserRef().collection('records');
            unsubscribe = ref.onSnapshot(snap => {
                records = snap.docs.map(d => ({id: d.id, ...d.data()}));
                records.sort((a,b) => new Date(b.date||0) - new Date(a.date||0));
                refreshCurrentView();
            }, error => {
                if(error.code === 'auth/operation-not-supported-in-this-environment') showToast("請用訪客模式", "toast-error");
            });
            checkAttendanceStatus();
            getUserRef().get().then(doc => { if(doc.exists && doc.data().customSources) customSources = doc.data().customSources; });
        }

        function saveData(data, id = null) {
            if (isGuest) {
                if (id) {
                    const idx = records.findIndex(r => r.id === id);
                    if (idx > -1) records[idx] = { ...records[idx], ...data };
                } else {
                    data.id = 'loc_' + Date.now();
                    records.unshift(data);
                }
                localStorage.setItem('hines_records_v6', JSON.stringify(records));
                return Promise.resolve();
            } else {
                const ref = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('records');
                if (id) return ref.doc(id).update(data);
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                return ref.add(data);
            }
        }

        function deleteData(id) {
            if (isGuest) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('hines_records_v6', JSON.stringify(records));
                return Promise.resolve();
            } else {
                return db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('records').doc(id).delete();
            }
        }

        function refreshData() { loadData(); showToast("已刷新"); }
        function refreshCurrentView() { switchView(currentFilter); }

        // --- Auth Handlers ---
        function handleGoogleLogin() { 
            if (window.location.protocol === 'file:') return showToast("本地檔案無法使用 Google 登入", "toast-error");
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => showToast(e.message,'toast-error')); 
        }
        function handleGuest() { 
            isGuest = true; currentUser = {uid:'guest',displayName:'本機用戶'}; 
            showApp(); 
            showToast("已進入訪客模式");
        }
        function handleLogout() { if(auth) auth.signOut(); location.reload(); }
        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            setTimeout(() => document.getElementById('app-container').classList.remove('opacity-0'), 50);
            document.getElementById('user-name').innerText = currentUser.displayName;
            document.getElementById('system-status').innerText = isGuest ? "OFFLINE MODE" : "CLOUD SYNC";
            loadData();
        }

        // --- View Logic ---
        function switchView(view) {
            currentFilter = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-blue-500'));
            document.getElementById(`nav-${view}`).classList.add('active', 'text-blue-500');

            const area = document.getElementById('content-area');
            area.innerHTML = '';
            
            let inc=0, exp=0;
            records.forEach(r => {
                if(r.type==='expense') exp += Number(r.amount||0);
                else if(r.type==='kwuntong') { 
                    inc+=Number(r.lower||0); 
                    exp+=Number(r.refund||0);
                    if(r.refunded) inc+=Number(r.refund||0); 
                } else {
                    if(r.type==='camel') inc += Number(r.upper||0)+Number(r.lower||0);
                    if(r.type==='reels') inc += Number(r.income||0);
                    if(r.type==='attendance') inc += Number(r.amount||0);
                }
            });

            if (view === 'dashboard') renderDashboard(area, inc, exp);
            else if (view === 'settings') renderSettings(area);
            else if (view === 'attendance') renderAttendance(area);
            else renderList(area, view);
        }

        function renderDashboard(container, inc, exp) {
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6 animate-fade-in">
                    <div class="glass-card p-4 text-center"><p class="text-xs text-gray-500 mb-1">總收入</p><p class="text-2xl font-bold text-green-400">$${inc}</p></div>
                    <div class="glass-card p-4 text-center"><p class="text-xs text-gray-500 mb-1">總入貨</p><p class="text-2xl font-bold text-red-400">$${exp}</p></div>
                </div>
                <div class="glass-card p-5 mb-6 animate-fade-in">
                     <p class="text-xs text-gray-500 mb-1">本月淨利潤</p>
                     <h1 class="text-4xl font-bold text-white mb-2">$${inc-exp}</h1>
                     <div class="w-full bg-[#2c2c2e] h-1.5 rounded-full overflow-hidden"><div class="bg-blue-600 h-full" style="width: ${inc>0 ? ((inc-exp)/inc)*100 : 0}%"></div></div>
                </div>
                <!-- Chart Legend -->
                <div class="glass-card p-4 mb-6 animate-fade-in">
                    <div class="h-56 relative mb-4"><canvas id="mainChart"></canvas></div>
                    <div class="flex flex-wrap justify-center gap-3 text-[10px] text-gray-400">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#0a84ff]"></div>駱駝漆</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#a855f7]"></div>Reels</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#eab308]"></div>觀塘</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#22c55e]"></div>打卡</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#ef4444]"></div>入貨</span>
                    </div>
                </div>
                <h3 class="text-sm font-bold text-gray-400 mb-3 px-1">最新動態</h3>
                <div class="space-y-2 pb-10 animate-fade-in">${records.slice(0, 5).map(renderCard).join('')}</div>
            `;
            setTimeout(() => renderChart(inc, exp), 100);
        }

        function renderList(container, type) {
            // FIX: Using correct function name renderList
            let filtered = type === 'income' ? records.filter(r => r.type !== 'expense') : records.filter(r => r.type === type);
            const groups = {};
            filtered.forEach(r => {
                const d = r.date || "2024-01-01"; const y = d.split('-')[0]; const m = d.split('-')[1];
                if(!groups[y]) groups[y] = {}; if(!groups[y][m]) groups[y][m] = []; groups[y][m].push(r);
            });

            let html = `
                <div class="flex justify-between items-center mb-6 animate-fade-in">
                    <h2 class="text-xl font-bold text-white capitalize flex items-center gap-2"><div class="w-1 h-5 bg-[#0a84ff] rounded-full"></div> ${getTitle(type)}</h2>
                    <button onclick="openEntry('${type}')" class="bg-[#0a84ff] text-white px-3 py-1.5 rounded-full text-xs font-bold active:scale-95 shadow-lg shadow-blue-900/30">+ 新增記錄</button>
                </div>
            `;
            const years = Object.keys(groups).sort().reverse();
            if(years.length === 0) html += `<div class="text-center py-20 text-gray-600 opacity-70"><i class="fa-solid fa-box-open text-3xl mb-3"></i><br>暫無資料</div>`;
            else {
                years.forEach(y => {
                    const isCurrentYear = y === new Date().getFullYear().toString();
                    html += `<details ${isCurrentYear?'open':''} class="mb-4 animate-slide-up"><summary class="glass-card p-3 rounded-2xl font-bold text-white mb-2 flex justify-between items-center select-none active:scale-[0.99] transition-transform"><span>${y} 年</span><i class="fa-solid fa-chevron-down text-gray-500 text-xs"></i></summary><div class="pl-2">`;
                    Object.keys(groups[y]).sort().reverse().forEach(m => {
                        html += `<div class="mb-3"><p class="text-xs text-gray-500 mb-2 ml-1 font-medium">${m} 月</p><div class="space-y-2 border-l-2 border-[#2c2c2e] pl-3">${groups[y][m].map(renderCard).join('')}</div></div>`;
                    });
                    html += `</div></details>`;
                });
            }
            container.innerHTML = html;
        }

        function renderAttendance(container) {
            container.innerHTML = `
                <div class="glass-card p-6 text-center mb-6 relative overflow-hidden animate-slide-up border border-[#2c2c2e]">
                    <p class="text-gray-500 text-xs mb-1 font-mono tracking-widest" id="clock-date">--/--</p>
                    <h1 class="text-5xl font-bold text-white font-mono tracking-tighter mb-4" id="clock-time">00:00</h1>
                    
                    <div id="active-work-info" class="hidden text-left bg-[#1c1c1e] p-3 rounded-xl mt-4">
                        <div><p class="text-[10px] text-gray-500 uppercase tracking-wider">工時</p><p class="text-2xl text-green-400 font-bold font-mono" id="work-duration">00:00:00</p></div>
                        <div class="grid grid-cols-2 gap-4 mt-2 pt-2 border-t border-[#2c2c2e]">
                            <div><p class="text-[10px] text-gray-500">1H 後</p><p class="text-sm text-white font-mono" id="est-1h">--:--</p></div>
                            <div><p class="text-[10px] text-gray-500">2H 後</p><p class="text-sm text-white font-mono" id="est-2h">--:--</p></div>
                        </div>
                    </div>
                    <p class="text-xs font-bold text-gray-500 mt-4 bg-[#2c2c2e] inline-block px-3 py-1 rounded-full" id="work-status-text">載入中...</p>
                </div>
                
                <div class="grid grid-cols-1 gap-3 max-w-xs mx-auto mb-10 animate-fade-in">
                    <button onclick="startWork()" id="btn-clock-in" class="py-4 bg-green-600 hover:bg-green-500 text-white rounded-2xl font-bold text-lg shadow-lg shadow-green-900/30 active:scale-95 transition-transform hidden btn-action">上班打卡</button>
                    <button onclick="endWork()" id="btn-clock-out" class="py-4 bg-red-600 hover:bg-red-500 text-white rounded-2xl font-bold text-lg shadow-lg shadow-red-900/30 active:scale-95 transition-transform hidden btn-action">下班結算</button>
                </div>
                
                <h3 class="text-sm font-bold text-gray-400 mb-3 px-2">最近打卡</h3>
                <div class="space-y-2 pb-20">${records.filter(r => r.type === 'attendance').slice(0, 10).map(renderCard).join('')}</div>
            `;
            checkAttendanceUI();
        }
        
        function renderSettings(container) {
             container.innerHTML = `
                <div class="glass-card p-6 animate-slide-up">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2">自定義入貨來源</h3>
                    <div id="source-list" class="flex flex-wrap gap-2 mb-6"></div>
                    <div class="flex gap-2">
                        <input id="new-source-input" type="text" placeholder="新增來源" class="modern-input flex-1 p-3 text-sm">
                        <button onclick="addSource()" class="px-4 bg-[#0a84ff] text-white rounded-xl active:scale-95 btn-action"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            `;
            renderSourceList();
        }

        // --- Components ---
        function renderCard(r) {
            let title = r.type==='camel'?'駱駝漆':(r.type==='kwuntong'?'觀塘':(r.type==='reels'?'Reels':(r.type==='attendance'?'薪資':(r.name||'入貨'))));
            let money = r.amount || (Number(r.upper)+Number(r.lower)) || r.income || Number(r.lower);
            if(r.type==='kwuntong' && r.refund) money = Number(r.lower);
            const isExp = r.type === 'expense';
            const colorClass = isExp ? 'text-red-400' : 'text-green-400';
            const sign = isExp ? '-' : '+';
            
            // Refund Action
            let extra = '';
            if (r.type === 'kwuntong' && r.refund > 0) {
                if (!r.refunded) extra = `<button onclick="event.stopPropagation(); confirmRefund('${r.id}')" class="ml-2 text-[10px] bg-red-500/20 text-red-400 px-2 py-0.5 rounded border border-red-500/30 btn-action hover:bg-red-500 hover:text-white">確認退款 $${r.refund}</button>`;
                else extra = `<span class="ml-2 text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded border border-green-500/30">已退 $${r.refund}</span>`;
            }

            return `
            <div class="glass-card p-4 rounded-xl flex justify-between items-center cursor-pointer relative overflow-hidden group btn-action" onclick="editRecord('${r.id}')">
                <div class="absolute left-0 top-0 bottom-0 w-1 ${isExp?'bg-red-500':'bg-green-500'} opacity-80"></div>
                <div class="ml-2 flex-1">
                    <h4 class="font-bold text-sm text-gray-200 flex items-center flex-wrap gap-1">${title} ${extra}</h4>
                    <p class="text-[11px] text-gray-500 mt-0.5">${r.date}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold ${colorClass}">${sign}$${money}</p>
                    <i class="fa-solid fa-chevron-right text-[10px] text-gray-600 ml-1"></i>
                </div>
            </div>`;
        }
        
        function getTitle(t) { const map = { 'camel': '駱駝漆', 'reels': 'Reels', 'kwuntong': '觀塘', 'expense': '入貨', 'income': '收入', 'attendance': '打卡' }; return map[t] || '列表'; }

        // --- Entry Modal Logic ---
        function openEntry(type, record=null) {
            activeType = type; activeEditId = record?.id;
            const modal = document.getElementById('entry-modal');
            const content = document.getElementById('modal-content');
            
            // Switcher Tabs
            const btns = document.querySelectorAll('.cat-item');
            btns.forEach(b => b.classList.remove('active'));
            const map = {camel:0, reels:1, kwuntong:2, expense:3};
            if(map[type]!==undefined) btns[map[type]].classList.add('active');
            
            document.getElementById('modal-submit-btn').innerText = record ? "更新" : "儲存";
            const delBtn = document.getElementById('modal-delete-btn');
            const submitBtn = document.getElementById('modal-submit-btn');
            
            if(record) { delBtn.classList.remove('hidden'); submitBtn.classList.remove('col-span-2'); } 
            else { delBtn.classList.add('hidden'); submitBtn.classList.add('col-span-2'); }
            
            renderEntryForm(type, record);
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.add('show');
            }, 10);
        }

        function switchEntryType(type) {
            if(activeEditId) return; 
            activeType = type;
            document.querySelectorAll('.cat-item').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderEntryForm(type, null);
        }

        function renderEntryForm(type, data) {
            const container = document.getElementById('modal-form-container');
            let today = new Date().toISOString().split('T')[0];
            let dateVal = data ? data.date : today;
            let html = `<div class="mb-4"><label class="text-xs text-gray-400 block mb-1">日期</label><input id="in-date" type="date" value="${dateVal}" class="modern-input w-full p-3 text-sm"></div>`;
            
            if(type==='camel') html += `<div class="flex gap-3 mb-3"><div><label class="text-xs text-gray-400 block mb-1">上層</label><input id="in-upper" type="number" value="${data?.upper||''}" onclick="openKeypad('in-upper')" readonly class="modern-input w-full p-3"></div><div><label class="text-xs text-gray-400 block mb-1">下層</label><input id="in-lower" type="number" value="${data?.lower||''}" onclick="openKeypad('in-lower')" readonly class="modern-input w-full p-3"></div></div><div class="mb-3"><label class="text-xs text-gray-400 block mb-1">備註</label><input id="in-note" type="text" value="${data?.note||''}" class="modern-input w-full p-3"></div>`;
            else if(type==='reels') html += `<div class="mb-3"><label class="text-xs text-gray-400 block mb-1">收入</label><input id="in-income" type="number" value="${data?.income||25}" onclick="openKeypad('in-income')" readonly class="modern-input w-full p-3"></div><div class="mb-3"><label class="text-xs text-gray-400 block mb-1">內容</label><input id="in-content" type="text" value="${data?.content||''}" class="modern-input w-full p-3"></div>`;
            else if(type==='kwuntong') html += `<div class="mb-3"><label class="text-xs text-gray-400 block mb-1">下層收入</label><input id="in-lower" type="number" value="${data?.lower||''}" onclick="openKeypad('in-lower')" readonly class="modern-input w-full p-3 text-yellow-400"></div><div class="mb-3"><label class="text-xs text-gray-400 block mb-1">退款金額</label><input id="in-refund" type="number" value="${data?.refund||''}" onclick="openKeypad('in-refund')" readonly class="modern-input w-full p-3 text-red-400"></div>`;
            else if(type==='expense') html += `<div class="flex gap-3 mb-3"><div><label class="text-xs text-gray-400 block mb-1">金額</label><input id="in-amount" type="number" value="${data?.amount||''}" onclick="openKeypad('in-amount')" readonly class="modern-input w-full p-3 text-pink-400"></div><div><label class="text-xs text-gray-400 block mb-1">項目</label><input id="in-name" type="text" value="${data?.name||''}" class="modern-input w-full p-3"></div></div><div class="mb-3"><label class="text-xs text-gray-400 block mb-1">來源</label><input id="in-source" type="text" value="${data?.source||''}" class="modern-input w-full p-3 mb-2"><div class="flex gap-2 flex-wrap">${customSources.map(s=>`<button onclick="document.getElementById('in-source').value='${s}'" class="text-xs bg-[#27272a] border border-[#3f3f46] px-3 py-1 rounded-full text-gray-300">${s}</button>`).join('')}</div></div>`;
            
            container.innerHTML = html;
        }

        function closeEntry() { 
            const content = document.getElementById('modal-content');
            const mask = document.getElementById('entry-mask');
            content.classList.remove('show');
            setTimeout(()=>document.getElementById('entry-modal').classList.add('hidden'), 300); 
            closeKeypad(); activeEditId=null; 
        }

        async function submitEntry() {
            const date = document.getElementById('in-date').value;
            if(!date) return showToast("請選擇日期", "toast");
            
            let data = { type: activeType, date };
            if(!activeEditId && !isGuest) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();

            // Collect
            if(activeType==='camel') { data.upper=getVal('in-upper'); data.lower=getVal('in-lower'); data.note=getVal('in-note'); }
            else if(activeType==='reels') { data.income=getVal('in-income'); data.content=getVal('in-content'); }
            else if(activeType==='kwuntong') { data.lower=getVal('in-lower'); data.refund=getVal('in-refund'); if(!activeEditId) data.refunded=false; }
            else if(activeType==='expense') { data.amount=getVal('in-amount'); data.name=getVal('in-name'); data.source=getVal('in-source'); }

            try {
                await saveData(data, activeEditId);
                showToast("儲存成功", "toast");
                closeEntry();
            } catch(e) { showToast("失敗", "toast"); }
        }

        function deleteFromModal() { if(confirm("確定刪除?")) deleteData(activeEditId).then(()=>{ showToast("已刪除","toast"); closeEntry(); }); }
        function getVal(id) { return document.getElementById(id)?.value || ''; }
        
        // --- Attendance & Utils ---
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.toLocaleDateString('zh-HK',{weekday:'short'})}`;
                const elTime = document.getElementById('clock-time');
                if(elTime) elTime.innerText = timeStr;
                const elDate = document.getElementById('clock-date');
                if(elDate) elDate.innerText = dateStr;

                if(workStartTime) {
                    const diff = now - workStartTime;
                    const hrs = Math.floor(diff / 3600000);
                    const mins = Math.floor((diff % 3600000) / 60000);
                    const secs = Math.floor((diff % 60000) / 1000);
                    const durEl = document.getElementById('work-duration');
                    if(durEl) durEl.innerText = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
                    
                    const oneHr = new Date(workStartTime.getTime() + 3600000);
                    const twoHr = new Date(workStartTime.getTime() + 7200000);
                    const el1 = document.getElementById('est-1h');
                    if(el1) el1.innerText = oneHr.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                    const el2 = document.getElementById('est-2h');
                    if(el2) el2.innerText = twoHr.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
                }
            }, 1000);
        }

        function checkAttendanceUI() {
            const btnIn = document.getElementById('btn-clock-in');
            const btnOut = document.getElementById('btn-clock-out');
            const status = document.getElementById('work-status-text');
            const panel = document.getElementById('active-work-info');
            if(!btnIn) return;

            if(workStartTime) {
                btnIn.classList.add('hidden'); btnOut.classList.remove('hidden'); panel.classList.remove('hidden');
                status.innerText = "工作中"; status.className = "inline-block px-4 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400";
            } else {
                btnIn.classList.remove('hidden'); btnOut.classList.add('hidden'); panel.classList.add('hidden');
                status.innerText = "準備就緒"; status.className = "inline-block px-4 py-1 rounded-full text-xs font-bold bg-[#2c2c2e] text-gray-400";
            }
        }
        
        async function startWork() {
            workStartTime = new Date();
            if(isGuest) localStorage.setItem('hines_attendance', workStartTime.toISOString());
            else await getUserRef().collection('attendance').doc('current').set({startTime: firebase.firestore.FieldValue.serverTimestamp()});
            checkAttendanceUI(); showToast("打卡成功", "toast");
        }

        async function endWork() {
            if(!workStartTime) return;
            const now = new Date();
            const diffMs = now - workStartTime;
            const mins = diffMs / 1000 / 60;
            const blocks = Math.ceil(mins / 30);
            const pay = blocks * 25;
            const hours = (blocks * 0.5).toFixed(1);
            
            const data = {
                type: 'attendance', date: now.toISOString().split('T')[0], amount: pay,
                clockIn: workStartTime.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}),
                clockOut: now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}),
                note: `工時: ${hours}小時`, createdAt: isGuest ? null : firebase.firestore.FieldValue.serverTimestamp()
            };

            await saveData(data);
            if(!isGuest) await getUserRef().collection('attendance').doc('current').delete();
            else localStorage.removeItem('hines_attendance');
            
            workStartTime = null; checkAttendanceUI(); showToast(`薪資 $${pay} 已入帳`, "toast"); refreshCurrentView();
        }

        // --- Shared Utils ---
        function confirmRefund(id) {
            if(confirm("確認此筆退款已完成？")) {
                if(isGuest) {
                    const idx = records.findIndex(r=>r.id===id);
                    if(idx>-1) { records[idx].refunded = true; saveData(records[idx], id); }
                } else {
                    getUserRef().collection('records').doc(id).update({refunded:true});
                }
                showToast("退款已確認", "toast");
            }
        }
        
        function showToast(m, t) { const c=document.getElementById('toast-container'); c.innerHTML=`<div class="toast"><span>${m}</span></div>`; setTimeout(()=>{c.innerHTML=''},3000); }
        function editRecord(id) { const r=records.find(i=>i.id===id); if(r) openEntry(r.type, r); }
        function closeConfirm(r) { document.getElementById('custom-confirm').classList.add('hidden'); }
        function openKeypad(id) { activeKeypadInput=document.getElementById(id); document.getElementById('custom-keypad').classList.remove('translate-y-full'); }
        function closeKeypad() { document.getElementById('custom-keypad').classList.add('translate-y-full'); activeKeypadInput=null; }
        function kpInput(v) { if(activeKeypadInput){ activeKeypadInput.value+=v; activeKeypadInput.dispatchEvent(new Event('input')); } }
        function kpDel() { if(activeKeypadInput) activeKeypadInput.value=activeKeypadInput.value.slice(0,-1); }
        function renderSourceList() { document.getElementById('source-list').innerHTML = customSources.map(s => `<span class="px-3 py-1 bg-[#27272a] rounded-full text-xs flex items-center gap-2 border border-[#3f3f46]">${s} <button onclick="removeSource('${s}')" class="text-red-400 btn-action"><i class="fa-solid fa-times"></i></button></span>`).join(''); }
        async function addSource() { const v=document.getElementById('new-source-input').value; if(v && !customSources.includes(v)) { customSources.push(v); if(isGuest) saveData(); else await getUserRef().set({customSources}, {merge:true}); renderSourceList(); } }
        async function removeSource(v) { customSources=customSources.filter(s=>s!==v); if(isGuest) saveData(); else await getUserRef().set({customSources}, {merge:true}); renderSourceList(); }
        function renderChart() {
            if(!records.length) return;
            const ctx=document.getElementById('mainChart');
            if(!ctx) return;
            // Simplified Chart Logic
            let s = {camel:0, reels:0, kwuntong:0, attendance:0, expense:0};
            records.forEach(r => {
                if(r.type==='camel') s.camel+=Number(r.upper)+Number(r.lower);
                if(r.type==='reels') s.reels+=Number(r.income);
                if(r.type==='kwuntong') s.kwuntong+=Number(r.lower);
                if(r.type==='attendance') s.attendance+=Number(r.amount);
                if(r.type==='expense' || (r.type==='kwuntong' && r.refund)) s.expense+=Number(r.amount || r.refund);
            });
            if(window.chart) window.chart.destroy(); 
            window.chart = new Chart(ctx.getContext('2d'), { 
                type:'doughnut', 
                data:{ 
                    labels:['駱駝','Reels','觀塘','打卡','入貨'], 
                    datasets:[{data:[s.camel, s.reels, s.kwuntong, s.attendance, s.expense], backgroundColor:['#0a84ff', '#a855f7', '#eab308', '#22c55e', '#ef4444'], borderWidth:0}] 
                }, 
                options:{cutout:'75%', plugins:{legend:{display:false}}, responsive:true, maintainAspectRatio:false} 
            }); 
        }

        // Start
        init();
    </script>
</body>
</html>